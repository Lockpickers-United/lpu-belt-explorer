import{r as n,D as v,A as N,bL as G,bM as J,bN as K,bO as Q,d as g,bR as q,bT as B,Y as p,j as b,B as R,bP as y,bU as V,aa as X}from"./index-D2wWF4eV.js";import{R as Z}from"./RaffleContext-D97lD4zr.js";import{c as h,b as x,s as w}from"./setDeep-J6HEwWhX.js";import"./useData-FrS22tTP.js";import"./dataUrls-DVxTtpO-.js";import"./index-CBULl7sm.js";function _({children:F}){const A=n.useContext(v),{authLoaded:a,isLoggedIn:i,user:j}=n.useContext(N),{profile:T,winnerData:I}=n.useContext(v),{raffleAdmin:l}=n.useContext(Z),[f,C]=n.useState(null),[S,W]=n.useState(!1),[m,O]=n.useState([]),[E,L]=n.useState(!1),$=n.useCallback(()=>m,[m]);n.useEffect(()=>{if(!(a&&i&&j&&l)){L(!1),O([]);return}const o=G(K(y,"raffle-entries"),J("status","!=","deleted")),r=Q(o,u=>{const c=[];u.forEach(d=>{c.push({...d.data(),id:d.id})}),O(c),L(!0),W(!0),console.log("DB, subscribedEntries, entry count:",c.length)},u=>{console.error("Error listening to DB:",u),C(!0),p("There was a problem reading the raffle entries. They will be unavailable until you refresh the page. ",{autoHideDuration:null,action:b.jsx(R,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})});return()=>r()},[a,i,l,j]);const P=n.useCallback(o=>{var d;let r={charities:{},pots:{},entriesByDate:{},totalEntries:0,totalDonations:0,totalTickets:0};r=o.filter(e=>e.status==="approved").length===0?r:o.sort((e,t)=>e.createdAt&&t.createdAt?g(e.createdAt).valueOf()-g(t.createdAt).valueOf():0).reduce((e,t)=>{if(!t||t.status!=="approved")return e;e.totalEntries=(e.totalEntries||0)+1,e.totalDonations=(e.totalDonations||0)+(t.totalDonation||0),e.totalTickets=(e.totalTickets||0)+(t.allocatedTickets||0);const s=t.createdAt?g(t.createdAt).format("YYYY-MM-DD"):"unknown";return h(e,["entriesByDate",s,"totalEntries"],1),h(e,["entriesByDate",s,"totalTickets"],t.allocatedTickets||0),h(e,["entriesByDate",s,"totalDonations"],t.totalDonation||0),h(e,["cumulativeDonations"],t.totalDonation||0),x(e,["entriesByDate",s,"cumulativeDonations"],e.cumulativeDonations||0),w(e,["uniqueDonors"],`${t.username}|${t.platform}`),x(e,["entriesByDate",s,"cumulativeUniqueDonors"],e.uniqueDonors.length||0),w(e,["entriesByDate",s,"uniqueDonors"],`${t.username}|${t.platform}`),x(e,["entriesByDate",s,"uniqueDonorCount"],e.entriesByDate[s].uniqueDonors.length||0),h(e,["beltDonorCount",t.belt],1),e.redditDonations=(e.redditDonations||0)+(t.platform==="Reddit"?t.totalDonation:0),e.discordDonations=(e.discordDonations||0)+(t.platform==="Discord"?t.totalDonation:0),t.donations.forEach(D=>{h(e,["charities",[D.charity.itemId],"totalDonations"],D.amount),w(e,["charities",[D.charity.itemId],"uniqueDonors"],`${t.username}|${t.platform}`),h(e,["beltDonations",t.belt],D.amount||0)},[]),t.pots.forEach(D=>{h(e,["pots",[D.itemId],"totalTickets"],D.tickets),w(e,["pots",[D.itemId],"uniqueDonors"],`${t.username}|${t.platform}`)},[]),e},{});const c=Object.entries(r.winnerCounts||{}).filter(([,e])=>(e||0)>=2).map(([e])=>e);return r.uniqueDonorCount=((d=r.uniqueDonors)==null?void 0:d.length)||0,delete r.uniqueDonors,Object.keys(r.charities).map(e=>{r.charities[e].uniqueDonorCount=r.charities[e].uniqueDonors.length||0,delete r.charities[e].uniqueDonors}),Object.keys(r.pots).map(e=>{r.pots[e].uniqueDonorCount=r.pots[e].uniqueDonors.length||0,delete r.pots[e].uniqueDonors}),Object.keys(r.entriesByDate).map(e=>{delete r.entriesByDate[e].uniqueDonors}),r={charities:{},pots:{},entriesByDate:{},totalEntries:0,totalDonations:0,totalTickets:0,...r,multipleWinners:c},r.updatedAt=g().toISOString(),r},[]),U=n.useCallback(async(o,r=!0)=>{if(f||!(a&&i&&l))return!1;if(!o||!o.id)throw new Error("updateRaffleEntry requires an entry with an id");const{id:u,fuzzy:c,...d}=o,e=Object.fromEntries(Object.entries(d).filter(([,s])=>s!==void 0));e.updatedAt=g().toISOString();const t=q(y,"raffle-entries",u);try{await B(t,e,{merge:!0}),r&&p("RAFL Entry Updated.")}catch(s){console.error("Error listening to DB:",s),C(!0),p("There was a problem saving the raffle entry. Please try refreshing the page. ",{autoHideDuration:null,action:b.jsx(R,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})}return!0},[a,i,l,f]),Y=n.useCallback(async(o,r,u=!0)=>{if(f||!(a&&i&&l))return!1;const c=q(y,"data-cache","raffle-winners");try{await B(c,{[o]:r},{merge:!0}),u&&p("RAFL Winners Updated.")}catch(d){console.error("Error listening to DB:",d),C(!0),p("There was a problem saving the raffle winners. Please try refreshing the page. ",{autoHideDuration:null,action:b.jsx(R,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})}return!0},[a,i,l,f]),H=n.useCallback(async o=>{if(f||!(a&&i&&l))return!1;if(!o||!o.id)throw new Error("deleteRaffleEntry requires an entry with an id");const r=q(y,"raffle-entries",o.id);try{return await V(r),p("RAFL Entry Deleted."),!0}catch(u){return console.error("Error deleting raffle entry:",u),C(!0),p("There was a problem deleting the raffle entry. Please try refreshing the page. ",{autoHideDuration:null,action:b.jsx(R,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})}),!1}},[a,i,l,f]),k=n.useCallback(async()=>{if(f||!(a&&i&&l)||!E)return!1;const o=q(y,"data-cache","raffle-entries-summary");await B(o,P(m))},[m,a,f,E,P,i,l]),M=n.useRef(!1);n.useEffect(()=>{if(E){if(!M.current){M.current=!0;return}k().catch(o=>console.error("Error saving summary:",o))}},[m,E,k,I]);const z=n.useMemo(()=>({...A,subscribedEntries:$,dbLoaded:S,entriesLoaded:E,saveSummary:k,profile:T,allRaffleEntries:m,updateRaffleEntry:U,deleteRaffleEntry:H,updateRaffleWinners:Y}),[A,$,S,E,k,T,m,U,H,Y]);return b.jsx(v.Provider,{value:z,children:F})}function ae(){return b.jsx(_,{children:b.jsx(X,{})})}export{ae as default};
