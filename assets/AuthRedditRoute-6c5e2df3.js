import{r as p,D as K,A as X,j as Z,l as C,a as tt}from"./index-eb603a81.js";import{I as et}from"./ImportPreview-2d438d5b.js";import"./dataUrls-29ba4993.js";import"./filterFields-dd2c1cc4.js";import"./ScorecardListContext-e5815fc1.js";import"./LoadingDisplay-a5c7ae7f.js";import"./Box-886c4dfb.js";import"./useData-2e4bb34b.js";import"./ScorecardRow-f1e5921e.js";import"./FieldValue-552e69e7.js";import"./Select-871d93a6.js";import"./BeltStripe-ef4d91a5.js";import"./BeltIcon-69956091.js";import"./Launch-6ae8645a.js";import"./useWindowSize-76259691.js";import"./PhotoCamera-181cbd2e.js";import"./Autocomplete-7c75fa7c.js";import"./Chip-348f45b6.js";import"./TextField-34131367.js";import"./index-900eb32d.js";import"./Dialog-764e8e06.js";import"./ListItem-ba37a8da.js";import"./FormGroup-f78ec690.js";import"./entryName-1183ff83.js";import"./Link-990ea4c2.js";import"./AccordionSummary-68d537ec.js";import"./Link-803fd1c7.js";import"./usePageTitle-4aa31c97.js";import"./useDocumentTitle-dafb543d.js";const at=/(white|yellow|orange|green|blue|purple|brown|red|black|(\d\d?)[th\s]*dan|dan[th\s]*(\d\d?))\s*(belt)?\s*(approved|granted)/i,rt=/approved|granted|congrat/i,G=[/white/i,/yellow/i,/orange/i,/green/i,/blue/i,/purple/i,/brown/i,/red/i,/black/i,/(\d\d?)[th\s]*dan/i,/dan[th\s]*(\d\d?)/i];function Lt(){const{getBookmarkForRedditUser:k,advanceBookmarkForRedditUser:_,oauthState:m}=p.useContext(K),{user:R}=p.useContext(X),{VITE_REDDIT_CLIENT_ID:n,VITE_REDDIT_CLIENT_SECRET:l}={VITE_LOCAL_DATA:"false",VITE_DISCORD_CLIENT_ID:"1271550138929774725",VITE_DISCORD_CLIENT_SECRET:"CoecO8cx2SyhMq2k3WdWNp-lavxYkeS-",VITE_REDDIT_CLIENT_ID:"i_lvEF-IFPalom2BR_lVjg",VITE_REDDIT_CLIENT_SECRET:"09PAhQfve1tysFh3jQAtmFaG5pWG0A",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1},e=window.location.href.match(/\?state=([^&]+)&code=([^#]+)#/);let f=e?e[1]:null;const A=f&&f.startsWith("DEBUG_DOWNLOAD");A&&(f=f.slice(14));const g=e?e[2]:null,M=window.location.href.match(/\?state=([^&]+)&error=([^#]+)#/),U=M?M[2]:null,[D,Q]=p.useState(null),[P,q]=p.useState({}),[J,w]=p.useState(!1),$=p.useRef(!1),Y=J||(Object.keys(P).length>0?"complete":!1);return p.useEffect(()=>{async function x(E){if(await m(E,f)){let d=null;try{d=await fetch("https://www.reddit.com/api/v1/access_token",{method:"POST",body:new URLSearchParams({grant_type:"authorization_code",code:encodeURIComponent(g),redirect_uri:`${location.origin}/#/auth/reddit`}).toString(),headers:{Authorization:"Basic "+btoa(n+":"+l),"Content-Type":"application/x-www-form-urlencoded"}})}catch{w("token_failed");return}if(d.status===200){const u=await d.json();Q({token:u.access_token,type:u.token_type})}else d.status===404?w("token_expired"):w("token_failed")}}g&&f&&R.uid&&!$.current?($.current=!0,x(R.uid)):U&&w("access_denied")},[g,f,U,R,n,l,m]),p.useEffect(()=>{async function x(E,d){let u=null,I=null,h=!1,O=null;try{O=await fetch("https://oauth.reddit.com/api/v1/me",{headers:{authorization:`${E} ${d}`}})}catch{h=!0}O.status===200?u=(await O.json()).name:h=!0;const N=await k(u);let j=null;try{j=await fetch("https://oauth.reddit.com/r/lockpicking/api/flairselector",{method:"POST",headers:{authorization:`${E} ${d}`}})}catch{h=!0}if(j.status===200){const a=(await j.json()).current.flair_text;if(a){const r=a.match(/^Black Belt (\d+)th Dan/),c=a.match(/^(\w+) Belt/);r?I=C(null,r[1]):c&&(I=C(c[1],null))}}else h=!0;const V=100;let z=!1,S=N,B=null,T=null,y=[],L=[];for(;!h&&!z;){const o=S?`&before=${S}`:"",a=B?`&after=${B}`:"",r=`https://oauth.reddit.com/message/inbox?limit=${V}`+o+a;let c=null;try{c=await fetch(r,{headers:{authorization:`${E} ${d}`}})}catch{h=!0}if(c.status===200){const i=(await c.json()).data;i.children.length>0&&(N?(S=i.children.reduce((t,s)=>!t.time||s.data.created_utc>t.time?{time:s.data.created_utc,mark:s.data.name}:t,{}).mark,T=S):(B=i.children.reduce((t,s)=>!t.time||s.data.created_utc<=t.time?{time:s.data.created_utc,mark:s.data.name}:t,{}).mark,T||(T=i.children[0].data.name))),i.children.length<V&&(z=!0);const F=i.children.filter(t=>t.kind==="t4"&&t.data.distinguished==="moderator"&&t.data.subreddit==="lockpicking"),H=F.map(t=>{let s=null;const v=ot(t.data.subject,t.data.body);v&&!tt(v,I)&&(s=v.id);let W=new Date(0);return W.setUTCSeconds(t.data.created_utc),{matchId:s,awardedAt:W.toUTCString(),link:`https://www.reddit.com/message/messages/${t.data.id}`}}).filter(t=>t.matchId);L=[...L,...F],y=[...y,...H]}else h=!0}if(h)w("data_failed");else if(A){const o=L.map(i=>({id:i.data.id,subject:i.data.subject,created_utc:i.data.created_utc,body:i.data.body})),a="data:application/json;base64,"+btoa(JSON.stringify(o)),r=await(await fetch(a)).blob(),c=window.URL.createObjectURL(r),b=document.createElement("a");b.download="reddit-modmail-debug.json",b.href=c,b.click(),window.URL.revokeObjectURL(c),w("debug_download")}else if(y.length>0){const o=Object.values(y.reduce((a,r)=>((!a[r.matchId]||new Date(r.awardedAt)<new Date(a[r.matchId].awardedAt))&&(a[r.matchId]=r),a),{}));await _(u,T,o),q({username:u,flair:I,awards:o})}else w("none_found");try{await fetch("https://www.reddit.com/api/v1/revoke_token",{method:"POST",body:new URLSearchParams({token:d,token_type_hint:E}).toString(),headers:{Authorization:"Basic "+btoa(n+":"+l),"Content-Type":"application/x-www-form-urlencoded"}})}catch{}}D&&x(D.type,D.token)},[D,_,k,n,l,A]),Z.jsx(et,{syncStatus:Y,syncResult:P,service:"Reddit"})}function ot(k,_){const m=_.match(at);if(m){const n=m[2]||m[3];return C(m[1],n)}if(_.match(rt)){let n=G.map(e=>_.match(e));n.some(e=>!!e)||(n=G.map(e=>k.match(e)));const l=n.filter(e=>!!e);if(l.length===1)return C(l[0][0],l[0][1])}return null}export{Lt as default};
