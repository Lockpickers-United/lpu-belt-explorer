import{r as p,D as X,A as Y,j as Z,l as g,a as tt}from"./index-Dr0OGwon.js";import{I as et}from"./ImportPreview-ZhW5vHjk.js";import"./dataUrls-DVxTtpO-.js";import"./ScorecardListContext-yODRk_Qa.js";import"./filterEntriesAdvanced-BDWbt3qc.js";import"./DataContext-CUJDkX2P.js";import"./index-CP9tfb4_.js";import"./filterFields-Bo4gHF6E.js";import"./LoadingDisplay-CWZwMqsw.js";import"./Box-DDFGBXTg.js";import"./CircularProgress-AJagqMNk.js";import"./useData-Up1CseKM.js";import"./ScorecardRow-BrbxiIkM.js";import"./ExpandMore--arwhoxw.js";import"./BeltStripe-COB2NIjK.js";import"./FieldValue-DGsn4PaS.js";import"./EvidenceForm-BWaUECwt.js";import"./Launch-DhYSTqIk.js";import"./ErrorOutline-RZ0jHWud.js";import"./PhotoCamera-BOgA8xxM.js";import"./LockEntrySearchBox-CK7qskF5.js";import"./Search-Bg9iyUBY.js";import"./useFormControl-DEFBuJ1H.js";import"./Select-DjCkLLij.js";import"./entryName-Cl_q4j5O.js";import"./BeltStripeMini-RD98hhzP.js";import"./TextField-BtThBk5p.js";import"./HighlightOff-B-BoThRr.js";/* empty css                  */import"./pageData-BY6jrYM9.js";import"./index-BOebgokl.js";import"./index-gksy22m8.js";import"./index-CSMEHI99.js";import"./sanitizeValues-CwpCv0SA.js";import"./LocalizationProvider-B0Ef2jfi.js";import"./index-FQoMmZZs.js";import"./colorManipulator-DudOWiFe.js";import"./DialogContent-DflWTjGS.js";import"./ListItem-CwnY8rTG.js";import"./Dialog-CRisLkfb.js";import"./VideocamOutlined-C-VPnNA9.js";import"./Checkbox-O4_7UYdV.js";import"./SwitchBase-CpUmf1c6.js";import"./LoadingDisplaySmall-BLtnVPNK.js";import"./Link-CC9_ppYP.js";import"./BeltIcon-DFHhbscL.js";import"./EmojiEvents-DzdboTBe.js";import"./AccordionSummary-8uGtQK7T.js";import"./Collapse-CoOZpONi.js";import"./usePageTitle-Dg-_QB3p.js";const at={VITE_REDDIT_CLIENT_ID:"i_lvEF-IFPalom2BR_lVjg",VITE_REDDIT_CLIENT_SECRET:"09PAhQfve1tysFh3jQAtmFaG5pWG0A"},rt=/(white|yellow|orange|green|blue|purple|brown|red|black|(\d\d?)[th\s]*dan|dan[th\s]*(\d\d?))\s*(belt)?\s*(approved|granted)/i,ot=/approved|granted|congrat/i,W=[/white/i,/yellow/i,/orange/i,/green/i,/blue/i,/purple/i,/brown/i,/red/i,/black/i,/(\d\d?)[th\s]*dan/i,/dan[th\s]*(\d\d?)/i];function ae(){const{getBookmarkForRedditUser:E,advanceBookmarkForRedditUser:_,oauthState:h}=p.useContext(X),{user:R}=p.useContext(Y),{VITE_REDDIT_CLIENT_ID:n,VITE_REDDIT_CLIENT_SECRET:l}=at,e=window.location.href.match(/\?state=([^&]+)&code=([^#]+)#/);let f=e?e[1]:null;const A=f&&f.startsWith("DEBUG_DOWNLOAD");A&&(f=f.slice(14));const j=e?e[2]:null,U=window.location.href.match(/\?state=([^&]+)&error=([^#]+)#/),M=U?U[2]:null,[y,Q]=p.useState(null),[$,J]=p.useState({}),[q,w]=p.useState(!1),P=p.useRef(!1),H=q||(Object.keys($).length>0?"complete":!1);return p.useEffect(()=>{async function x(b){if(await h(b,f)){let d=null;try{d=await fetch("https://www.reddit.com/api/v1/access_token",{method:"POST",body:new URLSearchParams({grant_type:"authorization_code",code:encodeURIComponent(j),redirect_uri:`${location.origin}/#/auth/reddit`}).toString(),headers:{Authorization:"Basic "+btoa(n+":"+l),"Content-Type":"application/x-www-form-urlencoded"}})}catch{w("token_failed");return}if(d.status===200){const u=await d.json();Q({token:u.access_token,type:u.token_type})}else d.status===404?w("token_expired"):w("token_failed")}}j&&f&&R.uid&&!P.current?(P.current=!0,x(R.uid)):M&&w("access_denied")},[j,f,M,R,n,l,h]),p.useEffect(()=>{async function x(b,d){let u=null,I=null,m=!1,C=null;try{C=await fetch("https://oauth.reddit.com/api/v1/me",{headers:{authorization:`${b} ${d}`}})}catch{m=!0}C.status===200?u=(await C.json()).name:m=!0;const z=await E(u);let v=null;try{v=await fetch("https://oauth.reddit.com/r/lockpicking/api/flairselector",{method:"POST",headers:{authorization:`${b} ${d}`}})}catch{m=!0}if(v.status===200){const a=(await v.json()).current.flair_text;if(a){const r=a.match(/^Black Belt (\d+)th Dan/),c=a.match(/^(\w+) Belt/);r?I=g(null,r[1]):c&&(I=g(c[1],null))}}else m=!0;const N=100;let F=!1,T=z,B=null,D=null,S=[],O=[];for(;!m&&!F;){const o=T?`&before=${T}`:"",a=B?`&after=${B}`:"",r=`https://oauth.reddit.com/message/inbox?limit=${N}`+o+a;let c=null;try{c=await fetch(r,{headers:{authorization:`${b} ${d}`}})}catch{m=!0}if(c.status===200){const i=(await c.json()).data;i.children.length>0&&(z?(T=i.children.reduce((t,s)=>!t.time||s.data.created_utc>t.time?{time:s.data.created_utc,mark:s.data.name}:t,{}).mark,D=T):(B=i.children.reduce((t,s)=>!t.time||s.data.created_utc<=t.time?{time:s.data.created_utc,mark:s.data.name}:t,{}).mark,D||(D=i.children[0].data.name))),i.children.length<N&&(F=!0);const G=i.children.filter(t=>t.kind==="t4"&&t.data.distinguished==="moderator"&&t.data.subreddit==="lockpicking"),K=G.map(t=>{let s=null;const L=it(t.data.subject,t.data.body);L&&!tt(L,I)&&(s=L.id);let V=new Date(0);return V.setUTCSeconds(t.data.created_utc),{matchId:s,awardedAt:V.toUTCString(),link:`https://www.reddit.com/message/messages/${t.data.id}`}}).filter(t=>t.matchId);O=[...O,...G],S=[...S,...K]}else m=!0}if(m)w("data_failed");else if(A){const o=O.map(i=>({id:i.data.id,subject:i.data.subject,created_utc:i.data.created_utc,body:i.data.body})),a="data:application/json;base64,"+btoa(JSON.stringify(o)),r=await(await fetch(a)).blob(),c=window.URL.createObjectURL(r),k=document.createElement("a");k.download="reddit-modmail-debug.json",k.href=c,k.click(),window.URL.revokeObjectURL(c),w("debug_download")}else if(S.length>0){const o=Object.values(S.reduce((a,r)=>((!a[r.matchId]||new Date(r.awardedAt)<new Date(a[r.matchId].awardedAt))&&(a[r.matchId]=r),a),{}));await _(u,D,o),J({username:u,flair:I,awards:o})}else w("none_found");try{await fetch("https://www.reddit.com/api/v1/revoke_token",{method:"POST",body:new URLSearchParams({token:d,token_type_hint:b}).toString(),headers:{Authorization:"Basic "+btoa(n+":"+l),"Content-Type":"application/x-www-form-urlencoded"}})}catch{}}y&&x(y.type,y.token)},[y,_,E,n,l,A]),Z.jsx(et,{syncStatus:H,syncResult:$,service:"Reddit"})}function it(E,_){const h=_.match(rt);if(h){const n=h[2]||h[3];return g(h[1],n)}if(_.match(ot)){let n=W.map(e=>_.match(e));n.some(e=>!!e)||(n=W.map(e=>E.match(e)));const l=n.filter(e=>!!e);if(l.length===1)return g(l[0][0],l[0][1])}return null}export{ae as default};
