import{r as u,D as Y,A as H,j as J,l as b,a as K}from"./index-4f731720.js";import{I as X}from"./ImportPreview-96c268c5.js";import"./dataUrls-29ba4993.js";import"./filterFields-bf88963a.js";import"./ScorecardListContext-d3440920.js";import"./LoadingDisplay-6ed7322e.js";import"./Box-159a28a2.js";import"./useData-313766e3.js";import"./ScorecardRow-4de0ee47.js";import"./FieldValue-3b7e6932.js";import"./Select-3b681fee.js";import"./BeltStripe-4360ae99.js";import"./BeltIcon-b42d224b.js";import"./Launch-f950e64d.js";import"./useWindowSize-2a97216a.js";import"./PhotoCamera-ec1cda71.js";import"./Autocomplete-1d4ba62b.js";import"./Chip-89c80f4c.js";import"./TextField-f393d9be.js";import"./index-500f8e6d.js";import"./Dialog-ea9af134.js";import"./ListItem-4ec0ac5a.js";import"./FormGroup-f92b4537.js";import"./entryName-91dee2a5.js";import"./Link-56f1f51e.js";import"./AccordionSummary-b6977054.js";import"./Link-1fc32bd2.js";import"./usePageTitle-35f06494.js";import"./useDocumentTitle-d87125b8.js";const Z=/(white|yellow|orange|green|blue|purple|brown|red|black|(\d\d?)[th\s]*dan|dan[th\s]*(\d\d?))\s*(belt)?\s*(approved|granted)/i,tt=/approved|granted|congrat/i,z=[/white/i,/yellow/i,/orange/i,/green/i,/blue/i,/purple/i,/brown/i,/red/i,/black/i,/(\d\d?)[th\s]*dan/i,/dan[th\s]*(\d\d?)/i];function vt(){const{getBookmarkForRedditUser:E,advanceBookmarkForRedditUser:p,oauthState:h}=u.useContext(Y),{user:k}=u.useContext(H),{VITE_REDDIT_CLIENT_ID:a,VITE_REDDIT_CLIENT_SECRET:d}={VITE_LOCAL_DATA:"false",VITE_DISCORD_CLIENT_ID:"1271550138929774725",VITE_DISCORD_CLIENT_SECRET:"CoecO8cx2SyhMq2k3WdWNp-lavxYkeS-",VITE_REDDIT_CLIENT_ID:"i_lvEF-IFPalom2BR_lVjg",VITE_REDDIT_CLIENT_SECRET:"09PAhQfve1tysFh3jQAtmFaG5pWG0A",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1},e=window.location.href.match(/\?state=([^&]+)&code=([^#]+)#/),D=e?e[1]:null,y=e?e[2]:null,j=window.location.href.match(/\?state=([^&]+)&error=([^#]+)#/),O=j?j[2]:null,[I,N]=u.useState(null),[M,F]=u.useState({}),[G,m]=u.useState(!1),L=u.useRef(!1),W=G||(Object.keys(M).length>0?"complete":!1);return u.useEffect(()=>{async function A(f){if(await h(f,D)){let n=null;try{n=await fetch("https://www.reddit.com/api/v1/access_token",{method:"POST",body:new URLSearchParams({grant_type:"authorization_code",code:encodeURIComponent(y),redirect_uri:`${location.origin}/#/auth/reddit`}).toString(),headers:{Authorization:"Basic "+btoa(a+":"+d),"Content-Type":"application/x-www-form-urlencoded"}})}catch{m("token_failed");return}if(n.status===200){const c=await n.json();N({token:c.access_token,type:c.token_type})}else n.status===404?m("token_expired"):m("token_failed")}}y&&D&&k.uid&&!L.current?(L.current=!0,A(k.uid)):O&&m("access_denied")},[y,D,O,k,a,d,h]),u.useEffect(()=>{async function A(f,n){let c=null,R=null,l=!1,x=null;try{x=await fetch("https://oauth.reddit.com/api/v1/me",{headers:{authorization:`${f} ${n}`}})}catch{l=!0}x.status===200?c=(await x.json()).name:l=!0;const P=await E(c);let g=null;try{g=await fetch("https://oauth.reddit.com/r/lockpicking/api/flairselector",{method:"POST",headers:{authorization:`${f} ${n}`}})}catch{l=!0}if(g.status===200){const r=(await g.json()).current.flair_text;if(r){const o=r.match(/^Black Belt (\d+)th Dan/),w=r.match(/^(\w+) Belt/);o?R=b(null,o[1]):w&&(R=b(w[1],null))}}else l=!0;const $=100;let V=!1,T=P,v=null,S=null,C=[];for(;!l&&!V;){const s=T?`&before=${T}`:"",r=v?`&after=${v}`:"",o=`https://oauth.reddit.com/message/inbox?limit=${$}`+s+r;let w=null;try{w=await fetch(o,{headers:{authorization:`${f} ${n}`}})}catch{l=!0}if(w.status===200){const _=(await w.json()).data;_.children.length>0&&(P?(T=_.children.reduce((t,i)=>!t.time||i.data.created_utc>t.time?{time:i.data.created_utc,mark:i.data.name}:t,{}).mark,S=T):(v=_.children.reduce((t,i)=>!t.time||i.data.created_utc<=t.time?{time:i.data.created_utc,mark:i.data.name}:t,{}).mark,S||(S=_.children[0].data.name))),_.children.length<$&&(V=!0);const q=_.children.filter(t=>t.kind==="t4"&&t.data.distinguished==="moderator"&&t.data.subreddit==="lockpicking").map(t=>{let i=null;const B=et(t.data.subject,t.data.body);B&&!K(B,R)&&(i=B.id);let U=new Date(0);return U.setUTCSeconds(t.data.created_utc),{matchId:i,awardedAt:U.toUTCString(),link:`https://www.reddit.com/message/messages/${t.data.id}`}}).filter(t=>t.matchId);C=[...C,...q]}else l=!0}if(l)m("data_failed");else if(C.length>0){const s=Object.values(C.reduce((r,o)=>((!r[o.matchId]||new Date(o.awardedAt)<new Date(r[o.matchId].awardedAt))&&(r[o.matchId]=o),r),{}));await p(c,S,s),F({username:c,flair:R,awards:s})}else m("none_found");try{await fetch("https://www.reddit.com/api/v1/revoke_token",{method:"POST",body:new URLSearchParams({token:n,token_type_hint:f}).toString(),headers:{Authorization:"Basic "+btoa(a+":"+d),"Content-Type":"application/x-www-form-urlencoded"}})}catch{}}I&&A(I.type,I.token)},[I,p,E,a,d]),J.jsx(X,{syncStatus:W,syncResult:M,service:"Reddit"})}function et(E,p){const h=p.match(Z);if(h){const a=h[2]||h[3];return b(h[1],a)}if(p.match(tt)){let a=z.map(e=>p.match(e));a.some(e=>!!e)||(a=z.map(e=>E.match(e)));const d=a.filter(e=>!!e);if(d.length===1)return b(d[0][0],d[0][1])}return null}export{vt as default};
