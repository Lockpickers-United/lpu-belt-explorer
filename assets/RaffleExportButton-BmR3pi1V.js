import{ad as ge,r as s,j as e,X as H,W as z,U as M,Y as ae,Z as ce,$ as de,a0 as pe,D as ue,u as V,R as A,B as Y,F as xe,L as je,A as we,ba as Ce,bb as be,P as q,T as ve,d as Se,ak as ke,a8 as $,at as _,a4 as G}from"./index-CQ85aNos.js";import{E as ye}from"./ExpandMore-WUBmDUp2.js";import{C as Ie}from"./CopyLinkToRaflPotButton-C4XbGCuV.js";import{F}from"./FieldValue--9A176Ml.js";import{F as U}from"./FilterChip-CmrXUqLt.js";import{I as Re}from"./ImageGallery-CQTppk3G.js";import{C as he}from"./ContentCopy-BEHu28xv.js";import{R as K}from"./RaffleContext-CM-Y-yQl.js";import{S as Te}from"./ScopedDialog-UyYHjVH9.js";import{L as Be}from"./LoadingDisplaySmall-CdFiPqRx.js";import{D as fe}from"./DataContext-7Iv33ZYY.js";import{C as We,L as Le}from"./LogEntryButton-I9hAA0mT.js";import{A as Fe,a as Ee,b as Ae}from"./AccordionSummary-BUkxYZQ2.js";import{C as De}from"./Collapse-CasjKIHi.js";import{B as Ne}from"./Box-CAHIzRvi.js";import{M as ee}from"./index-CabPlR85.js";import{r as te}from"./index-FQmDpc1k.js";import{A as ze}from"./AccordionActions-CWHTuDQr.js";import{d as ne,F as J,C as Me}from"./download-DQ3mLQT6.js";import{L as Pe}from"./List-t8oWD5O4.js";function Oe({entry:t}){const[n,i]=ge(),c=n.get("image"),l=s.useCallback(b=>{n.set("image",b+1),i(n)},[n,i]),p=s.useCallback(()=>{n.delete("image"),i(n)},[n,i]),o=s.useCallback(()=>se(c,t),[t,c]),r=s.useMemo(()=>c?+c-1:-1,[c]),x=se(r,t);return e.jsx(Re,{media:t.media,openIndex:r,initiallyOpen:x,onOpenImage:l,onCloseImage:p,onBackButton:o,shareParams:{id:t.id,name:n.get("name")},columns:2})}const se=(t,n)=>/\d+/.test(t)&&!!n.media[t];function qe({entry:t}){const n=s.useCallback(async()=>{const i=t.title;await navigator.clipboard.writeText(i),H("Pot name copied to clipboard.")},[t]);return e.jsx(z,{title:"Copy RAFL pot name",arrow:!0,disableFocusListener:!0,children:e.jsx(M,{onClick:n,children:e.jsx(he,{})})})}var D={},ie;function $e(){if(ie)return D;ie=1;var t=ae();Object.defineProperty(D,"__esModule",{value:!0}),D.default=void 0;var n=t(ce()),i=de();return D.default=(0,n.default)((0,i.jsx)("path",{d:"M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8"}),"Replay"),D}var _e=$e();const Ge=pe(_e);function me(t=[],n=1){const i=(t||[]).map(o=>({...o,tickets:Number((o==null?void 0:o.potTickets)||0)})).filter(o=>o.potTickets>0);if(!i.length||n<=0)return[];const c=i.slice(),l=[],p=o=>{const r=o.reduce((h,g)=>h+g.tickets,0);if(r<=0)return null;const x=Math.random()*r;let b=0;for(let h=0;h<o.length;h++)if(b+=o[h].tickets,x<b)return{winner:o[h],index:h};return{winner:o[o.length-1],index:o.length-1}};for(;l.length<n&&c.length>0;){const o=p(c);if(!o)break;l.push(o.winner),c.splice(o.index,1)}return l}function Ue(t){if(!t||!Array.isArray(t.entrants))return[];const n=Number((t==null?void 0:t.winnerCount)||1);return me(t.entrants,Math.max(1,n))}function oe({entry:t,drawing:n=!1,redrawId:i,excessWinner:c,containerRef:l}){var v;const{updateRaffleWinners:p}=s.useContext(ue),[o,r]=s.useState(!1),x=s.useCallback(a=>{a.preventDefault(),a.stopPropagation(),r(!1)},[]),b=t.winnerCount>1?"WINNERS":"WINNER",h=s.useCallback(async a=>{a.preventDefault(),a.stopPropagation();const u=Ue(t);await p(t.id,u),console.log("entry.winners",u)},[t,p]),g=s.useCallback(async(a,u)=>{a.preventDefault(),a.stopPropagation();try{const j=Array.isArray(t==null?void 0:t.winners)?t.winners.slice():[],S=Number((t==null?void 0:t.winnerCount)||1),y=new Set(j.map(m=>m.entryId));console.log("existingIds",y);const W=(Array.isArray(t==null?void 0:t.entrants)?t.entrants:[]).map(m=>({...m,tickets:Number((m==null?void 0:m.potTickets)||0)})).filter(m=>m.tickets>0&&(!m.entryId||!y.has(m.entryId)));if(console.log("eligible",W),!W.length){console.warn("No eligible entrants available for redraw for pot",t==null?void 0:t.id,"redrawId",u),r(!0);return}const[T]=me(W,1);if(!T){console.warn("Redraw failed to pick a new winner for pot",t==null?void 0:t.id);return}let I;if(S>1&&j.length>0){let m=!1;if(I=j.map(R=>!m&&(R==null?void 0:R.entryId)===u?(m=!0,T):R),!m){console.warn("Redraw id not found among current winners for pot",t==null?void 0:t.id,"idToRedraw",u);return}}else I=[T];await p(t.id,I),console.log("Redraw complete. Updated winners:",I)}catch(j){console.error("Error during redraw:",j)}},[t,p]),{isMobile:d}=V(),f=e.jsxs("div",{style:{textAlign:"center",fontWeight:700,fontSize:"1.1rem",padding:40},children:["There are no other eligible entries.",e.jsx("br",{}),e.jsx("br",{}),e.jsx(Y,{onClick:x,variant:"contained",children:"Sorry!"})," ",e.jsx("br",{}),e.jsx("br",{})]});return e.jsxs(A.Fragment,{children:[i&&n?e.jsx("div",{style:{marginLeft:2,color:"#f35454",fontWeight:"bold"},children:e.jsx(M,{onClick:a=>g(a,i),color:"secondary",variant:"contained",size:"small",style:{fontWeight:600,fontSize:"0.9rem",marginTop:d?0:-3,whiteSpace:"nowrap",color:c?"#f35454":"#666"},children:e.jsx(Ge,{fontSize:"small"})})}):!t.winners||((v=t.winners)==null?void 0:v.length)===0?e.jsx("div",{style:{marginLeft:20,marginTop:d?8:0},children:e.jsxs(Y,{onClick:h,color:"secondary",variant:"contained",size:"small",style:{fontWeight:600,fontSize:"0.9rem",marginTop:d?0:-3,whiteSpace:"nowrap",width:135},children:["DRAW ",b]})}):null,e.jsx(Te,{open:o,dialogContent:f,handleClose:x,containerRef:l,position:{top:80},centerX:!0,width:d?350:400})]})}function He({entry:t,drawing:n=!1}){var m,R,P;if(!t)return null;const{raflState:i,raffleAdminRole:c,excessWinners:l}=s.useContext(K),p=["live","post"].includes(i)||c,{setFilters:o}=s.useContext(xe),{isMobile:r,flexStyle:x}=V();let b=t.displayName?t.displayName:t.title;const h=t.winnerCount>1&&((m=t.winners)==null?void 0:m.length)===0?` (${t.winnerCount} winners)`:"",g=t.winnerCount>1?"Winners":"Winner",d=s.useCallback((k,L)=>{k&&typeof k.preventDefault=="function"&&k.preventDefault(),k&&typeof k.stopPropagation=="function"&&k.stopPropagation(),console.log("openWinnerPots entryId:",L),o({winnerEntryIds:L.entryId})},[o]),f=r?"100%":"auto",v=n?15:0,a=r?28:30,u=r?"1.1rem":"1.3rem",j="1rem",S=0,y=r?"1.15rem":"1.3rem",w=r?"1.5rem":"1.7rem",W=r?"1.1rem":"1.2rem",T=r?"1.2rem":"1.3rem",I=Array.isArray(t.winners)?e.jsx(A.Fragment,{children:t.winners.map((k,L)=>e.jsxs("div",{style:{display:"flex",justifyContent:"right",marginBottom:4},children:[L===0&&e.jsxs("span",{style:{fontWeight:400,color:"#fff"},children:[g,": "]}),e.jsx(je,{style:{color:l.includes(k.entryId)?"#f35454":"#fff",textAlign:"right"},onClick:O=>d(O,k),children:k.username}),e.jsx(oe,{entry:t,drawing:n,redrawId:k.entryId,excessWinner:l.includes(k.entryId)})]},L))}):void 0;return e.jsxs("div",{style:{width:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%",marginBottom:v},children:[p&&e.jsx("div",{style:{borderRadius:"50%",backgroundColor:"#fff",color:"#000",height:a,width:a,minWidth:a,marginTop:0,marginBottom:4,marginRight:12,display:"flex"},children:e.jsx("div",{style:{margin:"auto",paddingTop:0,paddingLeft:S,paddingRight:1,fontWeight:700,fontSize:u,lineHeight:j},children:t.potNumber})}),e.jsxs("div",{style:{display:x,flexDirection:"row",flexGrow:1,alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",flexGrow:1,fontWeight:500,fontSize:y,lineHeight:w,marginTop:r?0:-3},children:[b,e.jsxs("div",{style:{whiteSpace:"nowrap",fontSize:y,lineHeight:w},children:[" ",h]})]}),n&&e.jsx("div",{style:{display:"flex",justifyContent:"right",width:f},children:e.jsx(oe,{entry:t,drawing:n})})]}),((R=t.winners)==null?void 0:R.length)>0&&!r&&e.jsx("div",{style:{display:"flex",flexGrow:1,fontSize:W,lineHeight:T,marginTop:r?8:0,marginBottom:8,marginRight:12,fontWeight:600,justifyItems:"right"},children:e.jsx("div",{style:{width:"100%"},children:I})})]}),((P=t.winners)==null?void 0:P.length)>0&&r&&e.jsx("div",{style:{display:"flex",flexGrow:1,fontSize:W,lineHeight:T,marginTop:r?8:0,marginBottom:8,marginRight:12,fontWeight:600,justifyItems:"right"},children:e.jsx("div",{style:{width:"100%"},children:I})})]})}var N={},re;function Ye(){if(re)return N;re=1;var t=ae();Object.defineProperty(N,"__esModule",{value:!0}),N.default=void 0;var n=t(ce()),i=de();return N.default=(0,n.default)((0,i.jsx)("path",{d:"M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"}),"Star"),N}var Ve=Ye();const le=pe(Ve);function Je({id:t}){const{isLoggedIn:n}=s.useContext(we),{lockCollection:i,addToLockCollection:c,removeFromLockCollection:l}=s.useContext(ue),[p,o]=s.useState(()=>{}),r=!!p,{isMobile:x}=V(),[b,h]=s.useState(null),g="raffleWatchlist",d=s.useCallback(()=>!!i[g]&&i[g].includes(t),[t,i]),f=d()?"Remove from Watchlist":"Add to Watchlist",v=s.useCallback((w,W)=>async(T,I)=>{T.preventDefault(),T.stopPropagation(),h(w),I||!W?await c(w,t):await l(w,t),h(null)},[t,c,l]),a=s.useCallback(w=>{w.preventDefault(),w.stopPropagation(),o(w.currentTarget)},[]),u=s.useCallback(w=>{w.preventDefault(),w.stopPropagation(),o(null)},[]),j=36,y={marginTop:-2,marginRight:x?4:8,width:j,minWidth:j,height:j};return e.jsxs("div",{style:y,children:[n&&e.jsx("div",{style:{display:"flex",justifyItems:"left"},children:e.jsx(A.Fragment,{children:b===g?e.jsx("div",{style:{marginTop:1},children:e.jsx(Be,{})}):e.jsx(z,{title:f,arrow:!0,disableFocusListener:!0,children:e.jsx(M,{onClick:v(g,d()),style:{color:d()?"#13e113":"#999",...y},children:e.jsx(le,{})},g)})},g)}),!n&&e.jsxs(A.Fragment,{children:[e.jsx(z,{title:f,arrow:!0,disableFocusListener:!0,children:e.jsx(M,{onClick:a,style:{color:d()?"#13e113":"#999",...y},children:e.jsx(le,{})},g)}),e.jsx(Ce,{open:r,anchorEl:p,onClose:u,anchorOrigin:{vertical:"top",horizontal:"left"},children:e.jsx("div",{style:{display:"flex",padding:30,width:300,placeItems:"center"},onClick:u,children:e.jsxs("div",{children:[e.jsx("strong",{children:"Log in to keep a RAFL Watchlist!"}),e.jsx("br",{}),e.jsx("br",{}),e.jsx(be,{})]})})})]})]})}function Ke({entry:t,expanded:n,onExpand:i,single:c,drawing:l}){var L,O,X,Z,Q;if(!t)return null;const{raflState:p,raffleAdminRole:o}=s.useContext(K),{expandAll:r}=s.useContext(fe),x=["live","post"].includes(p)||o,{filters:b}=s.useContext(xe),h=!!b.shippingType||!!b.splitShipping,[g,d]=s.useState(!1),f={maxWidth:700,marginLeft:"auto",marginRight:"auto"},v=s.useRef(null),a=c==="2",u=t.totalTickets?new Intl.NumberFormat().format(t.totalTickets):"---";s.useEffect(()=>{if(n&&v&&!g&&!r){const C=window.innerWidth<=600?70:74;d(!0),setTimeout(()=>{window.scrollTo({left:0,top:v.current.offsetTop-C,behavior:n?"auto":"smooth"})},n?0:100)}else n||d(!1)},[n,t,g,r]);const j=s.useCallback((B,C)=>{i&&i(C?t.id:!1)},[t.id,i]),{isMobile:S,flexStyle:y}=V(),w=S?"12px 0px 8px 0px":"12px 0px 8px 8px",W=S?"0px 0px 0px 0px":"0px 0px 0px 8px",T=S?"12px 0px 0px 0px":"12px 0px 0px 8px",I=S?"1rem":"1.1rem",m=S?"0.95rem":"1.0rem",R=((L=t.winners)==null?void 0:L.length)>0&&!n?.5:1,P={Yes:"#50af53",No:"#d7584d",Split:"#e39a29","Buyer pays fees":"#e39a29"},k={Yes:"",No:"Cannot ship to the US",Split:"US winner splits duties & fees","Buyer pays fees":"US winner pays duties & fees"};return e.jsxs(Fe,{expanded:n,onChange:j,style:f,ref:v,children:[e.jsx(Ee,{expandIcon:a?null:e.jsx(ye,{}),children:e.jsx("div",{style:{width:"100%",marginBottom:20},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",flexGrow:1},children:[e.jsxs("div",{style:{display:"block",marginBottom:0,flexGrow:1},children:[e.jsx("div",{style:{display:"flex",width:"100%",alignItems:"center"},children:e.jsx("div",{style:{margin:w,display:"flex",flexGrow:1},children:e.jsx(He,{entry:t,drawing:l})})}),e.jsxs("div",{style:{margin:W,display:"flex"},children:[e.jsx("div",{style:{flexGrow:1,opacity:R},children:e.jsxs("div",{style:{marginRight:8,color:"#bbb",fontSize:"1.0rem"},children:["Contributed by  ",(O=t.contributedBy)==null?void 0:O.map((B,C)=>{const E=C<t.contributedBy.length-1?", ":"";return e.jsxs("span",{children:[e.jsx(U,{value:B,field:"contributedBy",mode:"text"}),E]},C)})]})}),x&&e.jsx(De,{in:t.uniqueDonorCount>0,children:e.jsxs("div",{style:{marginRight:10,fontSize:I,textAlign:"right",display:y,opacity:R},children:[e.jsx("div",{children:e.jsxs("nobr",{children:["Donors ",e.jsx("strong",{children:t.uniqueDonorCount||"--"})]})}),e.jsx("div",{style:{marginLeft:16},children:e.jsxs("nobr",{children:["Tickets ",e.jsx("strong",{children:u})]})})]})})]}),!a&&h&&e.jsxs("div",{style:{display:"flex",marginTop:6,opacity:R},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(F,{name:"Country",headerStyle:{marginBottom:4},value:t.country.map((B,C)=>{const E=C<t.country.length-1?", ":"";return e.jsxs("span",{children:[e.jsx(U,{value:B,field:"country",mode:"text"}),E]},C)})})}),e.jsx(F,{name:"Shipping Info",headerStyle:{marginBottom:4},value:t.shippingInfo})]}),t.description&&e.jsx(Ne,{style:{margin:T,fontSize:I,opacity:R},children:e.jsx(ee,{rehypePlugins:[[te,{target:"_blank"}]],components:{p:"div"},children:t.description})})]}),x&&!l&&e.jsx(Je,{id:t.id})]})})}),n&&e.jsxs(A.Fragment,{children:[e.jsxs(Ae,{sx:{padding:"0px 16px 0px 16px"},children:[t.shipsToUS&&t.shipsToUS!=="Yes"&&!l&&e.jsx("div",{style:{textAlign:"right",width:"100%",marginTop:5,paddingRight:20,color:P[t.shipsToUS],fontWeight:"bold",fontSize:"0.95rem"},children:k[t.shipsToUS]}),e.jsx("div",{style:{display:y},children:e.jsx(q,{direction:"row",alignItems:"flex-start",style:{},children:!!((X=t.tags)!=null&&X.length)&&!a&&e.jsx(F,{name:"Tags",value:e.jsx(q,{direction:"row",spacing:0,sx:{flexWrap:"wrap"},children:t.tags.map((B,C)=>e.jsx(U,{value:B,field:"tags",mode:"simple"},C))}),headerStyle:{marginBottom:4}})})}),!a&&!h&&e.jsxs("div",{style:{display:"flex",marginTop:6},children:[e.jsx("div",{style:{marginRight:10},children:e.jsx(F,{name:"Country",headerStyle:{marginBottom:4},value:t.country.map((B,C)=>{const E=C<t.country.length-1?", ":"";return e.jsxs("span",{children:[e.jsx(U,{value:B,field:"country",mode:"text"}),E]},C)})})}),e.jsx(F,{name:"Shipping Info",headerStyle:{marginBottom:4},value:t.shippingInfo})]}),t.potContents&&e.jsx(q,{direction:"row",spacing:1,sx:{width:"100%",flexWrap:"wrap",marginTop:"4px"},children:e.jsx(F,{name:"Contents",textStyle:{fontSize:m},value:e.jsx(ee,{rehypePlugins:[[te,{target:"_blank"}]],children:t.potContents})})}),!!((Z=t.media)!=null&&Z.length)&&e.jsx(F,{value:e.jsx(Oe,{entry:t})}),!!((Q=t.links)!=null&&Q.length)&&e.jsx(F,{name:"Links",value:e.jsx(q,{direction:"row",spacing:1,sx:{flexWrap:"wrap"},children:t.links.map(({title:B,url:C},E)=>e.jsx(Y,{href:C,target:"_blank",rel:"noopener noreferrer",color:"secondary",variant:"outlined",sx:{textTransform:"none"},style:{margin:4},children:B},E))})}),!r&&e.jsx(ve,{feature:"raflPot",id:t.id})]}),!a&&e.jsx(ze,{disableSpacing:!0,children:e.jsxs("div",{style:{display:"flex",width:"100%"},children:[e.jsxs("div",{style:{flexGrow:1,justifyItems:"left"},children:[e.jsx(We,{entry:t}),e.jsx(Le,{entry:t})]}),e.jsxs("div",{style:{display:"flex"},children:[e.jsx(qe,{entry:t}),x&&e.jsx(Ie,{entry:t})]})]})})]})]})}const gt=A.memo(Ke,(t,n)=>{const i=Object.keys(t.entry),c=Object.keys(n.entry);if(i.length!==c.length)return!1;for(let l=0;l<i.length;l++)if(i[l]!==c[l]||t.entry[i[l]]!==n.entry[c[l]])return!1;return t.expanded===n.expanded&&t.onExpand===n.onExpand});function jt({text:t}){const[n,i]=s.useState(null),c=!!n,l=s.useCallback(d=>i(d.currentTarget),[]),p=s.useCallback(()=>i(null),[]),o=Se().format("YYYY-MM-DD"),{raffleAdminRole:r}=s.useContext(K),{visibleEntries:x=[]}=s.useContext(fe),b=s.useCallback(()=>{const d=JSON.stringify(x);p(),ne(`rafflePots${o}.json`,d),H("Current RAFL pots downloaded as rafflePots.json")},[o,p,x]),h=s.useCallback(()=>{const d=x.map(f=>{const v=f.winnerCount>1?`(${f.winnerCount} winners)`:"";let a=`Pot #${f.potNumber} - ${f.title} ${v}
  DONATIONS: ${f.totalTickets}
  DONORS: ${f.uniqueDonorCount}
`;return f.winnerFilterNames.length>0&&(a+=`  WINNERS: ${f.winnerFilterNames.join(", ")}
`),a}).join(`
`);p(),navigator.clipboard.writeText(d).then(()=>{H("Current RAFL pots copied to clipboard.")})},[p,x]),g=s.useCallback(()=>{const d=x.map(u=>({id:u.id,potNumber:u.potNumber,title:u.title,contributedBy:u.contributedBy.join(", "),donors:u.uniqueDonorCount,tickets:u.totalTickets,winners:u.winnerFilterNames.join(", ")})),f=Object.keys(d[0]).join(","),v=d.map(u=>Object.keys(d[0]).map(j=>u[j]).map(j=>{const S=`${j??""}`.replace(/"/g,'""');return/(\s|,|")/.test(S)?`"${S}"`:S}).join(",")).join(`
`),a=`${f}
${v}`;p(),ne("rafflePots.csv",a),H("Current RAFL pots downloaded as rafflePots.csv")},[p,x]);return e.jsxs("div",{children:[t?e.jsx(z,{title:"Export",arrow:!0,disableFocusListener:!0,children:e.jsx(Y,{variant:"outlined",size:"small",onClick:l,style:{color:"#ddd",borderColor:"#aaa"},startIcon:e.jsx(J,{}),children:"Export"})}):e.jsx(z,{title:"Export",arrow:!0,disableFocusListener:!0,children:e.jsx(M,{onClick:l,children:e.jsx(J,{})})}),e.jsxs(ke,{anchorEl:n,open:c,onClose:p,children:[!t&&e.jsxs($,{disabled:!0,children:[e.jsx(_,{children:e.jsx(J,{fontSize:"small"})}),e.jsx(G,{children:"Export"})]}),e.jsxs($,{onClick:h,children:[e.jsx(_,{children:e.jsx(he,{fontSize:"small"})}),e.jsx(G,{children:"Copy to clipboard"})]}),e.jsxs($,{onClick:g,children:[e.jsx(_,{children:e.jsx(Pe,{fontSize:"small"})}),e.jsx(G,{children:"CSV"})]}),r&&e.jsxs($,{onClick:b,children:[e.jsx(_,{children:e.jsx(Me,{fontSize:"small"})}),e.jsx(G,{children:"JSON"})]})]})]})}export{gt as R,jt as a};
