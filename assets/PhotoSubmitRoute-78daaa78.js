import{u as U,r as o,as as le,j as e,R as q,a8 as ce,H as _,D as de,d as me,B as z,T as pe,bC as ue,Z as he,N as xe}from"./index-415cda15.js";import{I as fe}from"./IntroCopy-7e3b7871.js";import{u as ge}from"./usePageTitle-bb5bcb7e.js";import{d as je}from"./Search-159497ac.js";import{e as H}from"./entryName-19a7c345.js";import{A as ke}from"./Autocomplete-9cbdb066.js";import{T as D}from"./TextField-e08b4be9.js";import{I as be}from"./Chip-cd513c9a.js";import{B as ye}from"./BeltIcon-f10637c7.js";import{D as ve}from"./Dropzone-76dcb14f.js";import{L as Ce}from"./LoadingDisplay-6d84150e.js";import{D as Ne,a as Se}from"./DataContext-12a912fb.js";import"./index-14d87f72.js";import{a as Le}from"./axios-439bb627.js";import{C as Ie}from"./Checkbox-d1ba7039.js";import{C as Te}from"./Collapse-18a9be45.js";import{I as we,a as $e}from"./ImageListItem-9df95b93.js";import{D as A}from"./Dialog-427c4fd0.js";import{D as Be}from"./LockDataProvider-be18e745.js";import"./index-0c363d12.js";import"./index-d0c2f8d6.js";import"./index-05fee70f.js";import"./Link-fc95f3d7.js";import"./useDocumentTitle-0753ed46.js";import"./Select-bbe9f62e.js";import"./index-a5adc662.js";import"./Box-a82b671a.js";import"./CircularProgress-527f121c.js";function Fe({handleChangeLock:t,allEntries:r,disabled:c,reset:d=!1}){const s={maxWidth:700},{isMobile:m}=U(),k=o.useRef(),b=o.useMemo(()=>{let a={},l={};return{allLocks:r==null?void 0:r.sort((x,f)=>{le(x.belt,f.belt)||H(x,"short").localeCompare(H(f,"short"))}).reduce((x,f)=>{const v=f.version?" - "+f.version:"";return f.makeModels.map(C=>{const S=C.make?C.make:C.model,B=C.make?` ${C.model}`:"",R=`${S}${B}${v}`;x.push({id:f.id,lockName:R,make:S,model:B})}),x},[]).filter(x=>x),lockIds:a,lockNames:l}},[r]),{allLocks:i,lockIds:p,lockNames:L}=b,w=i.filter((a,l)=>i.findIndex(T=>T.lockName===a.lockName)!==l),N=i==null?void 0:i.map(a=>(a.lockName=w.find(l=>l.lockName===a.lockName)?a.lockName+` (${r.find(l=>l.id===a.id).belt})`:a.lockName,a)).map(a=>(p[a.lockName]=a.id,L[a.lockName]=`${a.make}${a.model}`,a.lockName)),I=o.useCallback((a,l)=>{l?N.includes(l)&&t({lockFullName:l,lockName:L[l],lockId:p[l]}):t({})},[p,L,N,t]),[y,$]=o.useState(!1),j=o.useCallback(()=>$(!1),[]);return e.jsxs(q.Fragment,{children:[e.jsx(ke,{disabled:c,selectOnFocus:!0,clearOnEscape:!0,handleHomeEndKeys:!0,fullWidth:!0,style:s,options:N,onChange:I,renderInput:a=>e.jsx(D,{...a,placeholder:"Search Locks",variant:"standard",color:"info",inputRef:k,InputProps:{...a.InputProps,startAdornment:e.jsx(be,{position:"start",children:e.jsx(je,{})})}})},d||c),e.jsx(ce,{invisible:!0,open:y&&m,onClick:j})]})}const De=async({user:t,url:r,formData:c,snackBars:d})=>{const s=new AbortController,m=setTimeout(()=>{s.abort()},1e4),k=Math.floor(Math.random()*1e5),b=t?await t.getIdToken():null,i=b?{Authorization:"Bearer "+b,"Content-Type":"multipart/form-data"}:{"Content-Type":"multipart/form-data"};try{const p=await Le.post(`${r}?${k}`,c,{headers:i,signal:s.signal});return clearTimeout(m),d&&_("Upload successful",{variant:"success"}),p.data}catch(p){throw clearTimeout(m),console.error("Error during authentication or server request:",Y(p)),d&&_("Error during authentication or server request",{variant:"error",autoHideDuration:3e3}),new Error(Y(p))}},Y=t=>{var r,c,d;if((r=t.response)!=null&&r.data&&typeof t.response.data=="string"){const s=(c=t.message.match(/code (\d+)/))==null?void 0:c[1],m=(d=t.response.data.match(/<pre>([\s\S]*?)<\/pre>/))==null?void 0:d[1];return{response:{data:{status:s,message:m}}}}else return t};function Re({profile:t,user:r}){var M;const{allEntries:c}=o.useContext(Ne),{updateProfileField:d}=o.useContext(de),[s,m]=o.useState({}),[k,b]=o.useState(void 0),[i,p]=o.useState([]),[L,w]=o.useState(void 0),[N,I]=o.useState(!1),[y,$]=o.useState(!1),[j,a]=o.useState(!1),[l,T]=o.useState(""),[x,f]=o.useState(""),[v,C]=o.useState((t==null?void 0:t.photoCredit)||(t==null?void 0:t.displayName)||""),[S,B]=o.useState(!1),R=me().format("YYYYMMDD-HHMMss"),g=c.find(n=>n.id===(s==null?void 0:s.lockId)),K=!!(s!=null&&s.lockName)&&!!(s!=null&&s.lockId)&&!!v&&i.length>0,W=`${s.lockName}_${s.lockId}_`.replace("/","+"),E=`${v}`.replace("/","+"),G=i.map(n=>n.name),Z=i.length===1?"File":"Files",J=async n=>{n.preventDefault(),I(!0);const u=`${R}_${W}_${E}`,h=new FormData;i.forEach(F=>{const{base:P,ext:ie}=Pe(F.name);h.append("files",F,`${u}/${W}_${P}_${E}.${ie}`)}),h.append("droppedFileNames",G),h.append("lockFullName",s.lockFullName),h.append("lockName",s.lockName),h.append("version",g==null?void 0:g.version),h.append("belt",g==null?void 0:g.belt),h.append("lockId",s.lockId),h.append("photoCredit",v),h.append("displayName",t==null?void 0:t.displayName),h.append("uploadsDir",u),h.append("notes",x);const ne="https://explore.lpubelts.com:8443/upload",re=!1;try{w(await De({user:r,url:ne,formData:h,snackBars:re})),V(v)}catch(F){$(F),m([]),i.forEach(P=>URL.revokeObjectURL(P.preview)),p([])}finally{I(!1)}},Q=o.useCallback(n=>{m(n),b(c.find(u=>u.id===n.lockId))},[c]),V=o.useCallback(n=>{d("photoCredit",n)},[d]),X=o.useCallback(n=>{const{value:u}=n.target;C(u)},[]),ee=o.useCallback(n=>{const{value:u}=n.target;f(u)},[]),O=o.useCallback(()=>{m({}),b(void 0),i.forEach(n=>URL.revokeObjectURL(n.preview)),p([]),w(void 0),I(!1),$(void 0),a(!1),T(""),f(""),B(!S)},[i,S]),te=o.useCallback(()=>{a(!j),m([])},[j]),oe=o.useCallback(n=>{const{value:u}=n.target;T(u),m({lockFullName:u,lockName:u,lockId:"NOTINLIST"})},[]),se=j?.5:1,{flexStyle:ae}=U();return e.jsxs("div",{style:{maxWidth:800,padding:0,marginLeft:"auto",marginRight:"auto",marginTop:16,marginBottom:46,paddingLeft:8},children:[e.jsx("form",{action:null,encType:"multipart/form-data",method:"post",onSubmit:J,children:e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:"Select Lock"}),e.jsx("div",{style:{opacity:se},children:e.jsx(Fe,{handleChangeLock:Q,allEntries:c,disabled:j,reset:S})}),e.jsxs("div",{style:{marginTop:8},children:[e.jsx(Ie,{onChange:te,color:"info",size:"small",id:"notInList",checked:j})," Submit photos for a lock not on the site."]}),e.jsxs(Te,{in:j,style:{marginTop:10},children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"Lock Name"}),e.jsx("br",{}),e.jsx(D,{type:"text",id:"altLockName",name:"altLockName",value:l,style:{width:400},onChange:oe,color:"info"})]}),e.jsx("br",{}),e.jsx("br",{}),e.jsxs("div",{style:{display:ae},children:[e.jsxs("div",{style:{marginRight:50,width:350},children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:["Files to Upload",e.jsx("br",{})]}),e.jsx(ve,{files:i,setFiles:p}),k&&e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10,marginTop:20},children:["Existing Images",e.jsx("br",{})]}),k.media?e.jsx("div",{children:e.jsx(we,{sx:{width:350},variant:"masonry",cols:2,gap:8,children:k.media.map(n=>e.jsx($e,{children:e.jsx("img",{srcSet:`${n.thumbnailUrl}?w=164&fit=crop&auto=format&dpr=2 2x`,src:`${n.thumbnailUrl}?w=164&fit=crop&auto=format`,alt:n.title,loading:"lazy"})},n.thumbnailUrl))})}):e.jsx("span",{children:"no images"})]})]}),e.jsxs("div",{style:{width:350},children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:["Details",e.jsx("br",{})]}),s.lockFullName&&e.jsxs("span",{children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"Lock Name"}),e.jsx("br",{}),e.jsxs("div",{style:{display:"flex"},children:[s.lockId!=="NOTINLIST"&&e.jsx(ye,{value:g==null?void 0:g.belt,style:{marginBottom:-10}}),e.jsx("div",{style:{fontWeight:700,fontSize:"1.2rem",marginLeft:10},children:s.lockFullName})]}),e.jsx("br",{})]}),e.jsx("span",{style:{fontSize:"0.9rem"},children:"Credit to"}),e.jsx("br",{}),e.jsx(D,{type:"text",name:"photoCredit",value:v,style:{width:350},onChange:X,color:"info"}),e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.9rem"},children:"Notes"}),e.jsx("br",{}),e.jsx(D,{type:"text",name:"notes",multiline:!0,fullWidth:!0,rows:3,color:"info",maxLength:1e3,id:"notes",value:x,onChange:ee}),e.jsx("br",{}),e.jsx("br",{}),e.jsx(z,{type:"submit",variant:"contained",color:"info",disabled:!K||N,children:"Upload"})]})]}),e.jsx("br",{}),e.jsx("br",{})]})}),e.jsx(A,{open:N,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{width:320,textAlign:"center",padding:30},children:e.jsx(Ce,{})})}),e.jsx(A,{open:!!L&&!y,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{display:"flex"},children:e.jsxs("div",{style:{backgroundColor:"#444",marginLeft:"auto",marginRight:"auto",padding:40},children:[e.jsxs("div",{style:{fontSize:"1.7rem",fontWeight:500,marginBottom:60,textAlign:"center"},children:[Z," Uploaded Succesfully!"]}),e.jsx("div",{style:{width:"100%",textAlign:"center"},children:e.jsx(z,{onClick:O,variant:"contained",color:"info",style:{marginLeft:"auto",marginRight:"auto"},children:"Submit more photos"})})]})})}),e.jsx(A,{open:!!y,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{display:"flex"},children:e.jsxs("div",{style:{backgroundColor:"#444",marginLeft:"auto",marginRight:"auto",padding:40},children:[e.jsxs("div",{style:{fontSize:"1.7rem",fontWeight:500,marginBottom:20,textAlign:"center"},children:["Something went wrong.",e.jsx("br",{}),"Please try again later.",e.jsx("br",{})]}),e.jsxs("div",{style:{fontSize:"0.85rem",fontWeight:400,marginBottom:20,textAlign:"center"},children:["Error message: ",(M=y==null?void 0:y.response)==null?void 0:M.data]}),e.jsx("div",{style:{width:"100%",textAlign:"center"},children:e.jsx(z,{onClick:O,variant:"contained",color:"error",style:{marginLeft:"auto",marginRight:"auto"},children:"OK"})})]})})}),e.jsx(pe,{feature:"uploadPhotos"})]})}function Pe(t){const r=t.lastIndexOf(".");return r===-1?{base:t,ext:""}:{base:t.substring(0,r),ext:t.substring(r)}}function dt(){const{isMobile:t}=U(),{profile:r,user:c}=ue();ge("LPU Belt Explorer - Submit Photos");const d=e.jsx(q.Fragment,{children:!t&&e.jsx("div",{style:{flexGrow:1,minWidth:"10px"}})});return e.jsx(Se,{children:e.jsxs(Be,{allEntries:he,profile:r,children:[e.jsx(xe,{title:"Submit Photos",extras:d}),r&&!r.photoCredit&&e.jsx("div",{style:{marginTop:20,padding:"0px 0px"},children:e.jsx(fe,{pageName:"photoUpload",maxWidth:820})}),e.jsx(Re,{profile:r,user:c})]})})}export{dt as default};
