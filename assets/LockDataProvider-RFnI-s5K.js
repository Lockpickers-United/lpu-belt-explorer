import{r as l,F as $,aC as J,ar as Q,d as p,M as C,aq as X,j as Y}from"./index-DUr27NUl.js";import{a as A,f as Z}from"./filterEntriesAdvanced-CGHt_bR4.js";import{D as ee}from"./DataContext-rhzy31h2.js";import{r as h}from"./index-DrkNI6xS.js";import{c as te}from"./collectionStatsById-DY1NVZ7h.js";import{u as oe}from"./useData-BSo5UGM7.js";import{i as se}from"./dataUrls-DVxTtpO-.js";import{s as ae}from"./setDeep-J6HEwWhX.js";import{i as re}from"./stringUtils-BsiQ3MZ5.js";import{e as x}from"./entryName-BJhAEJWP.js";function ke({children:K,allEntries:m,profile:i}){const{filters:W,advancedFilterGroups:y}=l.useContext($),{search:c,tab:f,sort:u,expandAll:U}=W,{data:B,loading:S,error:j}=oe({urls:le}),v=l.useMemo(()=>B&&!S&&!j?B.lockbazzarEntryIds:[],[B,j,S]),[z,F]=l.useState({A:"0.40",B:"0.25"}),[k,N]=l.useState("A"),d=l.useMemo(()=>{const t=(i==null?void 0:i.userLockNotes)||{};return m.map(e=>{var a,n,H,L,_;let s={};const r=(a=e.media)==null?void 0:a.map(o=>{var g,q;return o&&o.title&&((g=o.title)!=null&&g.includes("By:"))&&ae(s,["names"],o.title.replace("By: ","").trim()),(q=o==null?void 0:o.thumbnailUrl)!=null&&q.includes("flickr.com")&&(o.thumbnailUrl=o.thumbnailUrl.replace("_w_d.jpg","_w.jpg")),o});return{...e,media:r,makes:e.makeModels[0].make?e.makeModels.map(({make:o})=>o):e.makeModels[0].model,fuzzy:h([x(e,"long")].concat([e.searchKeywords,e.notes]).join(",")),fuzzyB:h(e.makeModels.map(({make:o,model:g})=>[o,g]).flat().filter(o=>o).concat([e.version,e.notes,e.belt]).join(",")),score:1,content:[(n=e.media)!=null&&n.some(o=>!o.fullUrl.match(/youtube\.com/))?"Has Images":"No Images",(H=e.media)!=null&&H.some(o=>o.fullUrl.match(/youtube\.com/))?"Has Video":"No Video",(L=e.media)!=null&&L.some(o=>o.label)?"Model Photos":void 0,((_=e.links)==null?void 0:_.length)>0?"Has Links":"No Links",Q[e.belt].danPoints>0?"Worth Dan Points":void 0,p(e.lastUpdated).isAfter(p().subtract(1,"days"))?"Updated Recently":void 0,e.belt!=="Unranked"?"Is Ranked":void 0,t[e.id]?"Has Personal Notes":void 0].flat().filter(o=>o),collection:J.locks.map.map(o=>i&&i[o.key]&&i[o.key].includes(e.id)?o.label:"Not "+o.label),collectionSaves:te[e.id]||0,simpleBelt:e.belt.replace(/\s\d/g,""),filterBelts:e.belt.startsWith("Black")?["Black",e.belt]:[e.belt],personalNotes:t[e.id],photographers:s==null?void 0:s.names}})},[m,i]),w=l.useMemo(()=>m.reduce((t,e)=>(e.makeModels.forEach(s=>{s.make&&!t.includes(s.make)&&t.push(s.make)}),t),[]).sort((t,e)=>t.localeCompare(e)),[m]),D=l.useMemo(()=>{var t;return c?(t=A.go(h(c),w,{limit:1,threshold:.2}).map(e=>({make:e.target,score:e.score})))==null?void 0:t[0]:void 0},[w,c]),E=l.useMemo(()=>{var t;return c?(t=A.go(h(c),d,{keys:G,limit:1,threshold:0}).map(e=>({name:x(e.obj,"long"),score:e.score})))==null?void 0:t[0]:void 0},[d,c]),b=l.useCallback(t=>{if(!c)return t;const e=c&&t.find(a=>a.id===c);if(e)return[e];const s=/^\/(.*)\/$/.exec(c);if(s&&re(s[1]))return t.reduce((a,n)=>(x(n,"long").match(new RegExp(s[1],"i"))&&a.push(n),a),[]);const r=k==="A"?A.go(h(c),t,{keys:G,threshold:-23e3}).map(a=>({...a.obj,score:a.score})).filter(a=>a.score>parseFloat(z.A)).sort((a,n)=>Math.floor(n.score*10)-Math.floor(a.score*10)||a.fuzzy.localeCompare(n.fuzzy)||C(a.belt,n.belt)):A.go(h(c),t,{keys:["fuzzyB"],threshold:-23e3}).map(a=>({...a.obj,score:a.score})).filter(a=>a.score>parseFloat(z.B));return k==="A"&&["master","master lock","abus"].includes(c.toLowerCase())?r.sort((a,n)=>parseFloat(a.modelNum||"99999")-parseFloat(n.modelNum||"99999")||Math.floor(n.score*10)-Math.floor(a.score*10)||a.fuzzy.localeCompare(n.fuzzy)):r},[c,z,k]),I=l.useMemo(()=>f==="search"||!f?b(d):b(d).filter(t=>t.simpleBelt===f),[d,b,f]),M=l.useMemo(()=>{const t=Z({advancedFilterGroups:y(),entries:d}),e=b([...t]);return u?e.sort((s,r)=>{if(u==="popularity")return r.collectionSaves-s.collectionSaves||r.views-s.views||s.fuzzy.localeCompare(r.fuzzy);if(u==="beltAscending")return C(s.belt,r.belt);if(u==="beltDescending")return X(s.belt,r.belt);if(u==="alphaAscending")return s.fuzzy.localeCompare(r.fuzzy);if(u==="alphaDescending")return r.fuzzy.localeCompare(s.fuzzy);if(u==="recentlyUpdated")return Math.floor(p(r.lastUpdated).valueOf()/3600)-Math.floor(p(s.lastUpdated).valueOf()/3600)||C(s.belt,r.belt)||s.fuzzy.localeCompare(r.fuzzy);if(u==="dateAdded")return Math.floor(p(r.dateAdded).valueOf()/3600*24)-Math.floor(p(s.dateAdded).valueOf()/3600*24)||C(s.belt,r.belt)||s.fuzzy.localeCompare(r.fuzzy)}):e},[y,d,b,u]),P=l.useCallback(t=>m.find(e=>e.id===t),[m]),R=l.useMemo(()=>f==="search"||!f?M:M.filter(t=>t.simpleBelt===f),[f,M]),O=l.useCallback(t=>v==null?void 0:v.includes(t),[v]),V=l.useMemo(()=>(i==null?void 0:i.blackBeltAwardedAt)>0,[i]),T=l.useMemo(()=>({allEntries:m,mappedEntries:d,searchedBeltEntries:I,visibleEntries:M,visibleBeltEntries:R,closestMake:D,anyMatch:E,getEntryFromId:P,expandAll:U,profile:i,blackBeltUser:V,lockbazzarAvailable:O,searchCutoff:z,setSearchCutoff:F,searchVariant:k,setSearchVariant:N}),[m,d,I,M,R,D,E,P,U,i,V,O,z,F,k,N]);return Y.jsx(ee.Provider,{value:T,children:K})}const G=["fuzzy"],le={lockbazzarEntryIds:se};export{ke as D};
