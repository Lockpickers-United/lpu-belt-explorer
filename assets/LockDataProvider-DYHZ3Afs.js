import{r as l,F as T,az as $,aq as J,d as p,K as A,ap as Q,j as X}from"./index-DmE7cyma.js";import{a as B,f as Y}from"./filterEntriesAdvanced-BJlux3Xz.js";import{D as Z}from"./DataContext-DqGjzQ70.js";import{r as h}from"./index-BpwLclf_.js";import{c as ee}from"./collectionStatsById-DY1NVZ7h.js";import{u as te}from"./useData-CBMicfRe.js";import{h as oe}from"./dataUrls-CThgH6Wi.js";import{s as se}from"./setDeep-J6HEwWhX.js";import{i as ae}from"./stringUtils-BsiQ3MZ5.js";import{e as y}from"./entryName-ChIjDb-x.js";function ze({children:q,allEntries:m,profile:n}){const{filters:G,advancedFilterGroups:x}=l.useContext(T),{search:c,tab:f,sort:i,expandAll:U}=G,{data:C,loading:S,error:j}=te({urls:re}),v=l.useMemo(()=>C&&!S&&!j?C.lockbazzarEntryIds:[],[C,j,S]),[z,F]=l.useState({A:"0.40",B:"0.25"}),[k,N]=l.useState("A"),d=l.useMemo(()=>{const t=(n==null?void 0:n.userLockNotes)||{};let a=[];return m.map(e=>{var s,u,H,L;const r=(s=e.media)==null?void 0:s.map(o=>{var g,K;return o&&o.title&&((g=o.title)!=null&&g.includes("By:"))&&se(a,[""],o.title.replace("By: ","").trim()),(K=o==null?void 0:o.thumbnailUrl)!=null&&K.includes("flickr.com")&&(o.thumbnailUrl=o.thumbnailUrl.replace("_w_d.jpg","_w.jpg")),o});return{...e,media:r,makes:e.makeModels[0].make?e.makeModels.map(({make:o})=>o):e.makeModels[0].model,fuzzy:h([y(e,"long")].concat([e.searchKeywords,e.notes]).join(",")),fuzzyB:h(e.makeModels.map(({make:o,model:g})=>[o,g]).flat().filter(o=>o).concat([e.version,e.notes,e.belt]).join(",")),score:1,content:[(u=e.media)!=null&&u.some(o=>!o.fullUrl.match(/youtube\.com/))?"Has Images":"No Images",(H=e.media)!=null&&H.some(o=>o.fullUrl.match(/youtube\.com/))?"Has Video":"No Video",((L=e.links)==null?void 0:L.length)>0?"Has Links":"No Links",J[e.belt].danPoints>0?"Worth Dan Points":void 0,p(e.lastUpdated).isAfter(p().subtract(1,"days"))?"Updated Recently":void 0,e.belt!=="Unranked"?"Is Ranked":void 0,t[e.id]?"Has Personal Notes":void 0].flat().filter(o=>o),collection:$.locks.map.map(o=>n&&n[o.key]&&n[o.key].includes(e.id)?o.label:"Not "+o.label),collectionSaves:ee[e.id]||0,simpleBelt:e.belt.replace(/\s\d/g,""),filterBelts:e.belt.startsWith("Black")?["Black",e.belt]:[e.belt],personalNotes:t[e.id],photographers:a==null?void 0:a.names}})},[m,n]),w=l.useMemo(()=>m.reduce((t,a)=>(a.makeModels.forEach(e=>{e.make&&!t.includes(e.make)&&t.push(e.make)}),t),[]).sort((t,a)=>t.localeCompare(a)),[m]),D=l.useMemo(()=>{var t;return c?(t=B.go(h(c),w,{limit:1,threshold:.2}).map(a=>({make:a.target,score:a.score})))==null?void 0:t[0]:void 0},[w,c]),E=l.useMemo(()=>{var t;return c?(t=B.go(h(c),d,{keys:_,limit:1,threshold:0}).map(a=>({name:y(a.obj,"long"),score:a.score})))==null?void 0:t[0]:void 0},[d,c]),b=l.useCallback(t=>{if(!c)return t;const a=c&&t.find(s=>s.id===c);if(a)return[a];const e=/^\/(.*)\/$/.exec(c);if(e&&ae(e[1]))return t.reduce((s,u)=>(y(u,"long").match(new RegExp(e[1],"i"))&&s.push(u),s),[]);const r=k==="A"?B.go(h(c),t,{keys:_,threshold:-23e3}).map(s=>({...s.obj,score:s.score})).filter(s=>s.score>parseFloat(z.A)).sort((s,u)=>Math.floor(u.score*10)-Math.floor(s.score*10)||s.fuzzy.localeCompare(u.fuzzy)||A(s.belt,u.belt)):B.go(h(c),t,{keys:["fuzzyB"],threshold:-23e3}).map(s=>({...s.obj,score:s.score})).filter(s=>s.score>parseFloat(z.B));return k==="A"&&["master","master lock","abus"].includes(c.toLowerCase())?r.sort((s,u)=>parseFloat(s.modelNum||"99999")-parseFloat(u.modelNum||"99999")||Math.floor(u.score*10)-Math.floor(s.score*10)||s.fuzzy.localeCompare(u.fuzzy)):r},[c,z,k]),I=l.useMemo(()=>f==="search"||!f?b(d):b(d).filter(t=>t.simpleBelt===f),[d,b,f]),M=l.useMemo(()=>{const t=Y({advancedFilterGroups:x(),entries:d}),a=b([...t]);return i?a.sort((e,r)=>{if(i==="popularity")return r.collectionSaves-e.collectionSaves||r.views-e.views||e.fuzzy.localeCompare(r.fuzzy);if(i==="beltAscending")return A(e.belt,r.belt);if(i==="beltDescending")return Q(e.belt,r.belt);if(i==="alphaAscending")return e.fuzzy.localeCompare(r.fuzzy);if(i==="alphaDescending")return r.fuzzy.localeCompare(e.fuzzy);if(i==="recentlyUpdated")return Math.floor(p(r.lastUpdated).valueOf()/3600)-Math.floor(p(e.lastUpdated).valueOf()/3600)||A(e.belt,r.belt)||e.fuzzy.localeCompare(r.fuzzy);if(i==="dateAdded")return Math.floor(p(r.dateAdded).valueOf()/3600*24)-Math.floor(p(e.dateAdded).valueOf()/3600*24)||A(e.belt,r.belt)||e.fuzzy.localeCompare(r.fuzzy)}):a},[x,d,b,i]),R=l.useCallback(t=>m.find(a=>a.id===t),[m]),O=l.useMemo(()=>f==="search"||!f?M:M.filter(t=>t.simpleBelt===f),[f,M]),P=l.useCallback(t=>v==null?void 0:v.includes(t),[v]),V=l.useMemo(()=>(n==null?void 0:n.blackBeltAwardedAt)>0,[n]),W=l.useMemo(()=>({allEntries:m,mappedEntries:d,searchedBeltEntries:I,visibleEntries:M,visibleBeltEntries:O,closestMake:D,anyMatch:E,getEntryFromId:R,expandAll:U,profile:n,blackBeltUser:V,lockbazzarAvailable:P,searchCutoff:z,setSearchCutoff:F,searchVariant:k,setSearchVariant:N}),[m,d,I,M,O,D,E,R,U,n,V,P,z,F,k,N]);return X.jsx(Z.Provider,{value:W,children:q})}const _=["fuzzy"],re={lockbazzarEntryIds:oe};export{ze as D};
