import{r as l,F as $,aA as J,aq as Q,d as p,K as A,ap as X,j as Y}from"./index-CKCuSFBF.js";import{a as B,f as Z}from"./filterEntriesAdvanced-CXoQ3lmF.js";import{D as ee}from"./DataContext-B1oLyf7Q.js";import{r as h}from"./index-X7fHUEzD.js";import{c as te}from"./collectionStatsById-DY1NVZ7h.js";import{u as oe}from"./useData-Cf4MysK_.js";import{h as se}from"./dataUrls-CThgH6Wi.js";import{s as ae}from"./setDeep-J6HEwWhX.js";import{i as re}from"./stringUtils-BsiQ3MZ5.js";import{e as x}from"./entryName-CnLmXQhK.js";function ke({children:G,allEntries:m,profile:i}){const{filters:W,advancedFilterGroups:y}=l.useContext($),{search:c,tab:f,sort:u,expandAll:U}=W,{data:C,loading:S,error:j}=oe({urls:le}),v=l.useMemo(()=>C&&!S&&!j?C.lockbazzarEntryIds:[],[C,j,S]),[z,F]=l.useState({A:"0.40",B:"0.25"}),[k,N]=l.useState("A"),d=l.useMemo(()=>{const t=(i==null?void 0:i.userLockNotes)||{};let a=[];return m.map(e=>{var s,n,H,L,K;const r=(s=e.media)==null?void 0:s.map(o=>{var g,_;return o&&o.title&&((g=o.title)!=null&&g.includes("By:"))&&ae(a,[""],o.title.replace("By: ","").trim()),(_=o==null?void 0:o.thumbnailUrl)!=null&&_.includes("flickr.com")&&(o.thumbnailUrl=o.thumbnailUrl.replace("_w_d.jpg","_w.jpg")),o});return{...e,media:r,makes:e.makeModels[0].make?e.makeModels.map(({make:o})=>o):e.makeModels[0].model,fuzzy:h([x(e,"long")].concat([e.searchKeywords,e.notes]).join(",")),fuzzyB:h(e.makeModels.map(({make:o,model:g})=>[o,g]).flat().filter(o=>o).concat([e.version,e.notes,e.belt]).join(",")),score:1,content:[(n=e.media)!=null&&n.some(o=>!o.fullUrl.match(/youtube\.com/))?"Has Images":"No Images",(H=e.media)!=null&&H.some(o=>o.fullUrl.match(/youtube\.com/))?"Has Video":"No Video",(L=e.media)!=null&&L.some(o=>o.label)?"Model Photos":void 0,((K=e.links)==null?void 0:K.length)>0?"Has Links":"No Links",Q[e.belt].danPoints>0?"Worth Dan Points":void 0,p(e.lastUpdated).isAfter(p().subtract(1,"days"))?"Updated Recently":void 0,e.belt!=="Unranked"?"Is Ranked":void 0,t[e.id]?"Has Personal Notes":void 0].flat().filter(o=>o),collection:J.locks.map.map(o=>i&&i[o.key]&&i[o.key].includes(e.id)?o.label:"Not "+o.label),collectionSaves:te[e.id]||0,simpleBelt:e.belt.replace(/\s\d/g,""),filterBelts:e.belt.startsWith("Black")?["Black",e.belt]:[e.belt],personalNotes:t[e.id],photographers:a==null?void 0:a.names}})},[m,i]),w=l.useMemo(()=>m.reduce((t,a)=>(a.makeModels.forEach(e=>{e.make&&!t.includes(e.make)&&t.push(e.make)}),t),[]).sort((t,a)=>t.localeCompare(a)),[m]),D=l.useMemo(()=>{var t;return c?(t=B.go(h(c),w,{limit:1,threshold:.2}).map(a=>({make:a.target,score:a.score})))==null?void 0:t[0]:void 0},[w,c]),E=l.useMemo(()=>{var t;return c?(t=B.go(h(c),d,{keys:q,limit:1,threshold:0}).map(a=>({name:x(a.obj,"long"),score:a.score})))==null?void 0:t[0]:void 0},[d,c]),b=l.useCallback(t=>{if(!c)return t;const a=c&&t.find(s=>s.id===c);if(a)return[a];const e=/^\/(.*)\/$/.exec(c);if(e&&re(e[1]))return t.reduce((s,n)=>(x(n,"long").match(new RegExp(e[1],"i"))&&s.push(n),s),[]);const r=k==="A"?B.go(h(c),t,{keys:q,threshold:-23e3}).map(s=>({...s.obj,score:s.score})).filter(s=>s.score>parseFloat(z.A)).sort((s,n)=>Math.floor(n.score*10)-Math.floor(s.score*10)||s.fuzzy.localeCompare(n.fuzzy)||A(s.belt,n.belt)):B.go(h(c),t,{keys:["fuzzyB"],threshold:-23e3}).map(s=>({...s.obj,score:s.score})).filter(s=>s.score>parseFloat(z.B));return k==="A"&&["master","master lock","abus"].includes(c.toLowerCase())?r.sort((s,n)=>parseFloat(s.modelNum||"99999")-parseFloat(n.modelNum||"99999")||Math.floor(n.score*10)-Math.floor(s.score*10)||s.fuzzy.localeCompare(n.fuzzy)):r},[c,z,k]),I=l.useMemo(()=>f==="search"||!f?b(d):b(d).filter(t=>t.simpleBelt===f),[d,b,f]),M=l.useMemo(()=>{const t=Z({advancedFilterGroups:y(),entries:d}),a=b([...t]);return u?a.sort((e,r)=>{if(u==="popularity")return r.collectionSaves-e.collectionSaves||r.views-e.views||e.fuzzy.localeCompare(r.fuzzy);if(u==="beltAscending")return A(e.belt,r.belt);if(u==="beltDescending")return X(e.belt,r.belt);if(u==="alphaAscending")return e.fuzzy.localeCompare(r.fuzzy);if(u==="alphaDescending")return r.fuzzy.localeCompare(e.fuzzy);if(u==="recentlyUpdated")return Math.floor(p(r.lastUpdated).valueOf()/3600)-Math.floor(p(e.lastUpdated).valueOf()/3600)||A(e.belt,r.belt)||e.fuzzy.localeCompare(r.fuzzy);if(u==="dateAdded")return Math.floor(p(r.dateAdded).valueOf()/3600*24)-Math.floor(p(e.dateAdded).valueOf()/3600*24)||A(e.belt,r.belt)||e.fuzzy.localeCompare(r.fuzzy)}):a},[y,d,b,u]),P=l.useCallback(t=>m.find(a=>a.id===t),[m]),R=l.useMemo(()=>f==="search"||!f?M:M.filter(t=>t.simpleBelt===f),[f,M]),O=l.useCallback(t=>v==null?void 0:v.includes(t),[v]),V=l.useMemo(()=>(i==null?void 0:i.blackBeltAwardedAt)>0,[i]),T=l.useMemo(()=>({allEntries:m,mappedEntries:d,searchedBeltEntries:I,visibleEntries:M,visibleBeltEntries:R,closestMake:D,anyMatch:E,getEntryFromId:P,expandAll:U,profile:i,blackBeltUser:V,lockbazzarAvailable:O,searchCutoff:z,setSearchCutoff:F,searchVariant:k,setSearchVariant:N}),[m,d,I,M,R,D,E,P,U,i,V,O,z,F,k,N]);return Y.jsx(ee.Provider,{value:T,children:G})}const q=["fuzzy"],le={lockbazzarEntryIds:se};export{ke as D};
