import{r as o,D as w,A as z,bE as G,bF as K,bG as N,bH as X,d as b,bK as C,bM as x,X as m,j as h,B as k,bI as E,bN as J,a9 as Q}from"./index-ClkGSI7P.js";import{R as V}from"./RaffleContext-DoPokjLO.js";import{c,b as B,s as y}from"./setDeep-J6HEwWhX.js";import"./useData-77-vFopR.js";import"./dataUrls-DVxTtpO-.js";import"./index-C1uLXjjT.js";function Z({children:M}){const v=o.useContext(w),{authLoaded:i,isLoggedIn:l,user:A}=o.useContext(z),{profile:j,winnerData:U}=o.useContext(w),{raffleAdmin:u}=o.useContext(V),[d,g]=o.useState(null),[S,Y]=o.useState(!1),[D,T]=o.useState([]),[p,O]=o.useState(!1),L=o.useCallback(()=>D,[D]);o.useEffect(()=>{if(!(i&&l&&A&&u)){O(!1),T([]);return}const n=G(N(E,"raffle-entries"),K("status","!=","deleted")),r=X(n,s=>{const e=[];s.forEach(t=>{e.push({...t.data(),id:t.id})}),T(e),O(!0),Y(!0),console.log("DB, subscribedEntries, entry count:",e.length)},s=>{console.error("Error listening to DB:",s),g(!0),m("There was a problem reading the raffle entries. They will be unavailable until you refresh the page. ",{autoHideDuration:null,action:h.jsx(k,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})});return()=>r()},[i,l,u,A]);const $=o.useCallback(n=>{let r=n.sort((e,t)=>e.createdAt&&t.createdAt?b(e.createdAt).valueOf()-b(t.createdAt).valueOf():0).reduce((e,t)=>{if(!t||t.status!=="approved")return e;e.totalEntries=(e.totalEntries||0)+1,e.totalDonations=(e.totalDonations||0)+(t.totalDonation||0),e.totalTickets=(e.totalTickets||0)+(t.allocatedTickets||0);const a=t.createdAt?b(t.createdAt).format("YYYY-MM-DD"):"unknown";return c(e,["entriesByDate",a,"totalEntries"],1),c(e,["entriesByDate",a,"totalTickets"],t.allocatedTickets||0),c(e,["entriesByDate",a,"totalDonations"],t.totalDonation||0),c(e,["cumulativeDonations"],t.totalDonation||0),B(e,["entriesByDate",a,"cumulativeDonations"],e.cumulativeDonations||0),y(e,["uniqueDonors"],`${t.username}|${t.platform}`),B(e,["entriesByDate",a,"cumulativeUniqueDonors"],e.uniqueDonors.length||0),y(e,["entriesByDate",a,"uniqueDonors"],`${t.username}|${t.platform}`),B(e,["entriesByDate",a,"uniqueDonorCount"],e.entriesByDate[a].uniqueDonors.length||0),c(e,["beltDonorCount",t.belt],1),e.redditDonations=(e.redditDonations||0)+(t.platform==="Reddit"?t.totalDonation:0),e.discordDonations=(e.discordDonations||0)+(t.platform==="Discord"?t.totalDonation:0),t.donations.forEach(f=>{c(e,["charities",[f.charity.itemId],"totalDonations"],f.amount),y(e,["charities",[f.charity.itemId],"uniqueDonors"],`${t.username}|${t.platform}`),c(e,["beltDonations",t.belt],f.amount||0)},[]),t.pots.forEach(f=>{c(e,["pots",[f.itemId],"totalTickets"],f.tickets),y(e,["pots",[f.itemId],"uniqueDonors"],`${t.username}|${t.platform}`)},[]),e},{});const s=Object.entries(r.winnerCounts||{}).filter(([,e])=>(e||0)>=2).map(([e])=>e);return r.uniqueDonorCount=r.uniqueDonors.length||0,delete r.uniqueDonors,Object.keys(r.charities).map(e=>{r.charities[e].uniqueDonorCount=r.charities[e].uniqueDonors.length||0,delete r.charities[e].uniqueDonors}),Object.keys(r.pots).map(e=>{r.pots[e].uniqueDonorCount=r.pots[e].uniqueDonors.length||0,delete r.pots[e].uniqueDonors}),Object.keys(r.entriesByDate).map(e=>{delete r.entriesByDate[e].uniqueDonors}),r={charities:{},pots:{},entriesByDate:{},totalEntries:0,totalDonations:0,totalTickets:0,...r,multipleWinners:s},r.updatedAt=b().toISOString(),r},[]),P=o.useCallback(async(n,r=!0)=>{if(d||!(i&&l&&u))return!1;if(!n||!n.id)throw new Error("updateRaffleEntry requires an entry with an id");const{id:s,fuzzy:e,...t}=n,a=Object.fromEntries(Object.entries(t).filter(([,R])=>R!==void 0));a.updatedAt=b().toISOString();const f=C(E,"raffle-entries",s);try{await x(f,a,{merge:!0}),r&&m("RAFL Entry Updated.")}catch(R){console.error("Error listening to DB:",R),g(!0),m("There was a problem saving the raffle entry. Please try refreshing the page. ",{autoHideDuration:null,action:h.jsx(k,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})}return!0},[i,l,u,d]),H=o.useCallback(async(n,r,s=!0)=>{if(d||!(i&&l&&u))return!1;const e=C(E,"data-cache","raffle-winners");try{await x(e,{[n]:r},{merge:!0}),s&&m("RAFL Winners Updated.")}catch(t){console.error("Error listening to DB:",t),g(!0),m("There was a problem saving the raffle winners. Please try refreshing the page. ",{autoHideDuration:null,action:h.jsx(k,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})})}return!0},[i,l,u,d]),F=o.useCallback(async n=>{if(d||!(i&&l&&u))return!1;if(!n||!n.id)throw new Error("deleteRaffleEntry requires an entry with an id");const r=C(E,"raffle-entries",n.id);try{return await J(r),m("RAFL Entry Deleted."),!0}catch(s){return console.error("Error deleting raffle entry:",s),g(!0),m("There was a problem deleting the raffle entry. Please try refreshing the page. ",{autoHideDuration:null,action:h.jsx(k,{color:"secondary",onClick:()=>location.reload(),children:"Refresh"})}),!1}},[i,l,u,d]),q=o.useCallback(async()=>{if(d||!(i&&l&&u)||!p)return!1;const n=C(E,"data-cache","raffle-entries-summary");await x(n,$(D))},[D,i,d,p,$,l,u]),I=o.useRef(!1);o.useEffect(()=>{if(p){if(!I.current){I.current=!0;return}q().catch(n=>console.error("Error saving summary:",n))}},[D,p,q,U]);const W=o.useMemo(()=>({...v,subscribedEntries:L,dbLoaded:S,entriesLoaded:p,saveSummary:q,profile:j,allRaffleEntries:D,updateRaffleEntry:P,deleteRaffleEntry:F,updateRaffleWinners:H}),[v,L,S,p,q,j,D,P,F,H]);return h.jsx(w.Provider,{value:W,children:M})}function se(){return h.jsx(Z,{children:h.jsx(Q,{})})}export{se as default};
