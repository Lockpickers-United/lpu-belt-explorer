import{u as U,r as o,as as ce,j as e,R as q,a8 as de,H as _,D as me,d as pe,B as z,T as ue,bC as he,Z as xe,N as fe}from"./index-0cca586d.js";import{I as ge}from"./IntroCopy-4e5a35e7.js";import{u as je}from"./usePageTitle-05f868ec.js";import{d as ke}from"./Search-691c127a.js";import{e as H}from"./entryName-b6f41071.js";import{A as be}from"./Autocomplete-cdb98017.js";import{T as D}from"./TextField-ab06e8a3.js";import{I as ye}from"./Chip-032b290d.js";import{B as ve}from"./BeltIcon-137f403d.js";import{D as Ce}from"./Dropzone-3d1b166b.js";import{L as Ne}from"./LoadingDisplay-f1d3c6ca.js";import{D as Se,a as Le}from"./DataContext-799eb883.js";import"./index-6b4aac19.js";import{a as Ie}from"./axios-439bb627.js";import{C as Te}from"./Checkbox-e3d23e99.js";import{C as we}from"./Collapse-5182e410.js";import{I as $e,a as Be}from"./ImageListItem-7faf8e89.js";import{D as A}from"./Dialog-0dae4477.js";import{D as Fe}from"./LockDataProvider-c141624c.js";import"./index-ba4f8566.js";import"./index-7dbc03cb.js";import"./index-cd9d140f.js";import"./Link-7e6fcc5a.js";import"./useDocumentTitle-3f4c92d6.js";import"./Select-66954567.js";import"./index-ea2cded5.js";import"./Box-3938c30a.js";import"./CircularProgress-745bf919.js";function De({handleChangeLock:t,allEntries:r,disabled:c,reset:d=!1}){const a={maxWidth:700},{isMobile:m}=U(),k=o.useRef(),N=o.useMemo(()=>{let s={},l={};return{allLocks:r==null?void 0:r.sort((x,f)=>{ce(x.belt,f.belt)||H(x,"short").localeCompare(H(f,"short"))}).reduce((x,f)=>{const v=f.version?" - "+f.version:"";return f.makeModels.map(C=>{const L=C.make?C.make:C.model,B=C.make?` ${C.model}`:"",R=`${L}${B}${v}`;x.push({id:f.id,lockName:R,make:L,model:B})}),x},[]).filter(x=>x),lockIds:s,lockNames:l}},[r]),{allLocks:i,lockIds:g,lockNames:h}=N,w=i.filter((s,l)=>i.findIndex(T=>T.lockName===s.lockName)!==l),S=i==null?void 0:i.map(s=>(s.lockName=w.find(l=>l.lockName===s.lockName)?s.lockName+` (${r.find(l=>l.id===s.id).belt})`:s.lockName,s)).map(s=>(g[s.lockName]=s.id,h[s.lockName]=`${s.make}${s.model}`,s.lockName)),I=o.useCallback((s,l)=>{l?S.includes(l)&&t({lockFullName:l,lockName:h[l],lockId:g[l]}):t({})},[g,h,S,t]),[y,$]=o.useState(!1),b=o.useCallback(()=>$(!1),[]);return e.jsxs(q.Fragment,{children:[e.jsx(be,{disabled:c,selectOnFocus:!0,clearOnEscape:!0,handleHomeEndKeys:!0,fullWidth:!0,style:a,options:S,onChange:I,renderInput:s=>e.jsx(D,{...s,placeholder:"Search Locks",variant:"standard",color:"info",inputRef:k,InputProps:{...s.InputProps,startAdornment:e.jsx(ye,{position:"start",children:e.jsx(ke,{})})}})},d||c),e.jsx(de,{invisible:!0,open:y&&m,onClick:b})]})}const Re=async({user:t,url:r,formData:c,snackBars:d,timeoutDuration:a=1e4})=>{const m=new AbortController,k=setTimeout(()=>{m.abort()},a),N=Math.floor(Math.random()*1e6),i=t?await t.getIdToken():null,g=i?{Authorization:"Bearer "+i,"Content-Type":"multipart/form-data"}:{"Content-Type":"multipart/form-data"};try{const h=await Ie.post(`${r}?${N}`,c,{headers:g,signal:m.signal});return clearTimeout(k),d&&_("Upload successful",{variant:"success"}),h.data}catch(h){throw clearTimeout(k),console.error("Error during authentication or server request:",Y(h)),d&&_("Error during authentication or server request",{variant:"error",autoHideDuration:3e3}),new Error(Y(h))}},Y=t=>{var r,c,d;if((r=t.response)!=null&&r.data&&typeof t.response.data=="string"){const a=(c=t.message.match(/code (\d+)/))==null?void 0:c[1],m=(d=t.response.data.match(/<pre>([\s\S]*?)<\/pre>/))==null?void 0:d[1];return{response:{data:{status:a,message:m}}}}else return t};function Pe({profile:t,user:r}){var M;const{allEntries:c}=o.useContext(Se),{updateProfileField:d}=o.useContext(me),[a,m]=o.useState({}),[k,N]=o.useState(void 0),[i,g]=o.useState([]),[h,w]=o.useState(void 0),[S,I]=o.useState(!1),[y,$]=o.useState(!1),[b,s]=o.useState(!1),[l,T]=o.useState(""),[x,f]=o.useState(""),[v,C]=o.useState((t==null?void 0:t.photoCredit)||(t==null?void 0:t.displayName)||""),[L,B]=o.useState(!1),R=pe().format("YYYYMMDD-HHMMss"),j=c.find(n=>n.id===(a==null?void 0:a.lockId)),K=!!(a!=null&&a.lockName)&&!!(a!=null&&a.lockId)&&!!v&&i.length>0,W=`${a.lockName}_${a.lockId}_`.replace("/","+"),E=`${v}`.replace("/","+"),G=i.map(n=>n.name),Z=i.length===1?"File":"Files",J=async n=>{n.preventDefault(),I(!0);const p=`${R}_${W}_${E}`,u=new FormData;i.forEach(F=>{const{base:P,ext:le}=ze(F.name);u.append("files",F,`${p}/${W}_${P}_${E}.${le}`)}),u.append("droppedFileNames",G),u.append("lockFullName",a.lockFullName),u.append("lockName",a.lockName),u.append("version",j==null?void 0:j.version),u.append("belt",j==null?void 0:j.belt),u.append("lockId",a.lockId),u.append("photoCredit",v),u.append("displayName",t==null?void 0:t.displayName),u.append("uploadsDir",p),u.append("notes",x);const ne="https://explore.lpubelts.com:8443/upload",re=!1,ie=15e3;try{w(await Re({user:r,url:ne,formData:u,snackBars:re,timeoutDuration:ie})),V(v)}catch(F){$(F),m([]),i.forEach(P=>URL.revokeObjectURL(P.preview)),g([])}finally{I(!1)}},Q=o.useCallback(n=>{m(n),N(c.find(p=>p.id===n.lockId))},[c]),V=o.useCallback(n=>{d("photoCredit",n)},[d]),X=o.useCallback(n=>{const{value:p}=n.target;C(p)},[]),ee=o.useCallback(n=>{const{value:p}=n.target;f(p)},[]),O=o.useCallback(()=>{m({}),N(void 0),i.forEach(n=>URL.revokeObjectURL(n.preview)),g([]),w(void 0),I(!1),$(void 0),s(!1),T(""),f(""),B(!L)},[i,L]),te=o.useCallback(()=>{s(!b),m([])},[b]),oe=o.useCallback(n=>{const{value:p}=n.target;T(p),m({lockFullName:p,lockName:p,lockId:"NOTINLIST"})},[]),se=b?.5:1,{flexStyle:ae}=U();return e.jsxs("div",{style:{maxWidth:800,padding:0,marginLeft:"auto",marginRight:"auto",marginTop:16,marginBottom:46,paddingLeft:8},children:[e.jsx("form",{action:null,encType:"multipart/form-data",method:"post",onSubmit:J,children:e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:"Select Lock"}),e.jsx("div",{style:{opacity:se},children:e.jsx(De,{handleChangeLock:Q,allEntries:c,disabled:b,reset:L})}),e.jsxs("div",{style:{marginTop:8},children:[e.jsx(Te,{onChange:te,color:"info",size:"small",id:"notInList",checked:b})," Submit photos for a lock not on the site."]}),e.jsxs(we,{in:b,style:{marginTop:10},children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"Lock Name"}),e.jsx("br",{}),e.jsx(D,{type:"text",id:"altLockName",name:"altLockName",value:l,style:{width:400},onChange:oe,color:"info"})]}),e.jsx("br",{}),e.jsx("br",{}),e.jsxs("div",{style:{display:ae},children:[e.jsxs("div",{style:{marginRight:50,width:350},children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:["Files to Upload",e.jsx("br",{})]}),e.jsx(Ce,{files:i,setFiles:g}),k&&e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10,marginTop:20},children:["Existing Images",e.jsx("br",{})]}),k.media?e.jsx("div",{children:e.jsx($e,{sx:{width:350},variant:"masonry",cols:2,gap:8,children:k.media.map(n=>e.jsx(Be,{children:e.jsx("img",{srcSet:`${n.thumbnailUrl}?w=164&fit=crop&auto=format&dpr=2 2x`,src:`${n.thumbnailUrl}?w=164&fit=crop&auto=format`,alt:n.title,loading:"lazy"})},n.thumbnailUrl))})}):e.jsx("span",{children:"no images"})]})]}),e.jsxs("div",{style:{width:350},children:[e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:500,marginBottom:10},children:["Details",e.jsx("br",{})]}),a.lockFullName&&e.jsxs("span",{children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"Lock Name"}),e.jsx("br",{}),e.jsxs("div",{style:{display:"flex"},children:[a.lockId!=="NOTINLIST"&&e.jsx(ve,{value:j==null?void 0:j.belt,style:{marginBottom:-10}}),e.jsx("div",{style:{fontWeight:700,fontSize:"1.2rem",marginLeft:10},children:a.lockFullName})]}),e.jsx("br",{})]}),e.jsx("span",{style:{fontSize:"0.9rem"},children:"Credit to"}),e.jsx("br",{}),e.jsx(D,{type:"text",name:"photoCredit",value:v,style:{width:350},onChange:X,color:"info"}),e.jsx("br",{}),e.jsx("br",{}),e.jsx("span",{style:{fontSize:"0.9rem"},children:"Notes"}),e.jsx("br",{}),e.jsx(D,{type:"text",name:"notes",multiline:!0,fullWidth:!0,rows:3,color:"info",maxLength:1e3,id:"notes",value:x,onChange:ee}),e.jsx("br",{}),e.jsx("br",{}),e.jsx(z,{type:"submit",variant:"contained",color:"info",disabled:!K||S,children:"Upload"})]})]}),e.jsx("br",{}),e.jsx("br",{})]})}),e.jsx(A,{open:S,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{width:320,textAlign:"center",padding:30},children:e.jsx(Ne,{})})}),e.jsx(A,{open:!!h&&!y,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{display:"flex"},children:e.jsxs("div",{style:{backgroundColor:"#444",marginLeft:"auto",marginRight:"auto",padding:40},children:[e.jsxs("div",{style:{fontSize:"1.7rem",fontWeight:500,marginBottom:60,textAlign:"center"},children:[Z," Uploaded Succesfully!"]}),e.jsx("div",{style:{width:"100%",textAlign:"center"},children:e.jsx(z,{onClick:O,variant:"contained",color:"info",style:{marginLeft:"auto",marginRight:"auto"},children:"Submit more photos"})})]})})}),e.jsx(A,{open:!!y,componentsProps:{backdrop:{style:{backgroundColor:"#000",opacity:.7}}},children:e.jsx("div",{style:{display:"flex"},children:e.jsxs("div",{style:{backgroundColor:"#444",marginLeft:"auto",marginRight:"auto",padding:40},children:[e.jsxs("div",{style:{fontSize:"1.7rem",fontWeight:500,marginBottom:20,textAlign:"center"},children:["Something went wrong.",e.jsx("br",{}),"Please try again later.",e.jsx("br",{})]}),e.jsxs("div",{style:{fontSize:"0.85rem",fontWeight:400,marginBottom:20,textAlign:"center"},children:["Error message: ",(M=y==null?void 0:y.response)==null?void 0:M.data]}),e.jsx("div",{style:{width:"100%",textAlign:"center"},children:e.jsx(z,{onClick:O,variant:"contained",color:"error",style:{marginLeft:"auto",marginRight:"auto"},children:"OK"})})]})})}),e.jsx(ue,{feature:"uploadPhotos"})]})}function ze(t){const r=t.lastIndexOf(".");return r===-1?{base:t,ext:""}:{base:t.substring(0,r),ext:t.substring(r)}}function mt(){const{isMobile:t}=U(),{profile:r,user:c}=he();je("LPU Belt Explorer - Submit Photos");const d=e.jsx(q.Fragment,{children:!t&&e.jsx("div",{style:{flexGrow:1,minWidth:"10px"}})});return e.jsx(Le,{children:e.jsxs(Fe,{allEntries:xe,profile:r,children:[e.jsx(fe,{title:"Submit Photos",extras:d}),r&&!r.photoCredit&&e.jsx("div",{style:{marginTop:20,padding:"0px 0px"},children:e.jsx(ge,{pageName:"photoUpload",maxWidth:820})}),e.jsx(Pe,{profile:r,user:c})]})})}export{mt as default};
